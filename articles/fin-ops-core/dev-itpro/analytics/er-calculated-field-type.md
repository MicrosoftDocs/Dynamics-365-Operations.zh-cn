---
title: 支持对计算字段类型的 ER 数据源执行参数化调用
description: 此主题提供有关如何对 ER 数据源使用计算字段类型的信息。
author: NickSelin
manager: AnnBe
ms.date: 09/09/2019
ms.topic: article
ms.prod: ''
ms.service: dynamics-ax-platform
ms.technology: ''
audience: Application User, Developer, IT Pro
ms.reviewer: kfend
ms.search.scope: Core, Operations
ms.custom: ''
ms.assetid: ''
ms.search.region: Global
ms.author: nselin
ms.search.validFrom: ''
ms.dyn365.ops.version: 10.0.5
ms.openlocfilehash: 20d48795b23628bbba2896bf48940936a25e0435
ms.sourcegitcommit: 75db3b75d35d27034f9b56e7119c9d0cb7666830
ms.translationtype: HT
ms.contentlocale: zh-CN
ms.lasthandoff: 10/03/2019
ms.locfileid: "2550076"
---
# <a name="support-parameterized-calls-of-er-data-sources-of-the-calculated-field-type"></a>支持对计算字段类型的 ER 数据源执行参数化调用

[!include [banner](../includes/banner.md)]

此主题介绍如何使用**计算字段**类型设计电子申报 (ER) 数据源。 此数据库中可以包含一个 ER 表达式，其在执行时由调用此数据源的绑定中配置的参数自变量的值控制。 通过配置此类数据源的参数化调用，可以在大量绑定中重复使用一个数据源，从而减少必须在 ER 模型映射或 ER 格式中配置的数据源的总数。 还可以简化配置的 ER 组件，从而降低维护成本和其他使用者的使用成本。

## <a name="prerequisites"></a>先决条件
要完成本主题中的示例，您必须具有以下访问权限：

- 访问以下角色之一：

    - 电子申报开发人员
    - 电子申报功能顾问
    - 系统管理员

- 对于下列角色之一，访问已为与 Finance and Operations 相同的租户配置的 Regulatory Configuration Services (RCS)：

    - 电子申报开发人员
    - 电子申报功能顾问
    - 系统管理员

从 [Microsoft 下载中心](https://go.microsoft.com/fwlink/?linkid=874684)下载压缩文件**支持对计算字段类型的 ER 数据源执行参数化调用**。 其中包含必须提取并存储到本地的以下 ER 配置。

| **内容**                           | **文件名**                                        |
|---------------------------------------|------------------------------------------------------|
| 示例 ER 数据模型配置    | 用于了解参数化调用的模型.版本.1.xml     |
| 示例 ER 元数据配置      | 用于了解参数化调用的元数据.版本.1.xml  |
| 示例 ER 模型映射配置 | 用于了解参数化调用的映射.版本.1.1.xml |
| 示例 ER 格式配置        | 用于了解参数化调用的格式.版本.1.1.xml  |

## <a name="sign-in-to-your-rcs-instance"></a>登录您的 RCS 实例
在此示例中，将为示例公司 Litware 公司创建一个配置。首先必须在 RCS 中完成[创建一个配置提供程序，并标记其为当前运行的](tasks/er-configuration-provider-mark-it-active-2016-11.md)过程中的步骤：

1. 在默认仪表板中，选择**电子申报**。
2. 选择**申报配置**。
3. 按照以下顺序将下载的配置导入到 RCS 中：数据模型、元数据、模型映射、格式。 为每个 ER 配置完成以下步骤：

    1. 选择**交换**。
    2. 选择**从 XML 文件加载**。
    3. 选择**浏览**，然后选择 XML 格式的所需 ER 配置。
    4. 选择**确定**。

## <a name="review-the-provided-er-solution"></a>查看提供的 ER 解决方案

### <a name="review-model-mapping"></a>查看模型映射

1. 在配置树中，展开**用于了解参数化调用的模型**项的内容。
2. 选择**用于了解参数化调用的映射**。
3. 选择**设计器**。
4. 选择**设计器**。  
   
此 ER 模型映射用于执行以下操作：

- 提取 **TaxTable** 表中的税码（**税**数据源）的列表。
- 提取 **TaxTrans** 表中的税务交易记录（**交易记录**数据源）的列表：
    
    - 按税码为提取的交易记录（**组**数据源）列表分组。
    - 按税码计算分组的交易记录的以下聚合值：

        - 税金基数值的和。
        - 税金值的和。
        - 采用的税率的最小值。

此配置中的模型映射实施为此模型创建并在 Finance and Operations 中执行的任何 ER 格式的基本数据模型。 结果，**Tax**和 **Gr** 数据源的内容将对抽象数据源之类 ER 格式公开。

  ![其中显示“税”和“组”数据源的模型映射设计器页面](media/er-calculated-field-type-01.png)

5.  关闭**模型映射设计器**页。
6.  关闭**模型映射**页。

### <a name="review-format"></a>查看格式

1. 在配置树中，展开**用于了解参数化调用的模型**项的内容。
2. 选择**用于了解参数化调用的格式**。
3. 选择**设计器**。 此 ER 格式用于执行以下操作：

  - 生成 XML 格式的报税单。
  - 在报税单中提供以下征税级别：正常、减税、免税。
  - 在每个征税级别提供多项详细信息，从而每个级别包含不同数量的详细信息。

  ![“格式设计器”页面](media/er-calculated-field-type-02.png)

4. 选择**映射**。
5. 展开**模型**、**数据**和**摘要**项。 

   计算字段**模型.数据.摘要.级别**中包含表达式，用于将征税级别（**正常**、**减税**、**免税**或**其他**）的代码作为可在运行时从**模型.数据.摘要**数据源检索的任何税码的文本值返回。

  ![其中显示“用于了解参数化调用的数据模型”模型的详细信息的格式设计器页面](media/er-calculated-field-type-03.png)

6. 展开**模型**.**数据2** 项。
7. 展开**模型**.**数据2.摘要2** 项。
   
   配置**模型**.**数据2.摘要2** 数据源是为了按（**模型.数据.摘要.级别**计算字段返回的）征税级别为**模型.数据.摘要**数据源交易记录详细信息分组和计算聚合。

  ![其中显示“模型.数据2.摘要2”数据源的详细信息的格式设计器页面](media/er-calculated-field-type-04.png)

8. 查看计算字段**模型**.**数据2.级别1**、**模型**.**数据2.级别2** 和**模型**.**数据2.级别3**。 这些计算字段用于筛选**模型**.**数据2.摘要2** 记录列表和仅返回表示特定征税级别的记录。
9. 关闭**格式设计器**页。

## <a name="create-a-derived-format"></a>创建派生格式
可通过添加一个计算字段来筛选所需征税级别，而不是使用现有三个字段，改进提供的格式：**模型**.**数据2.级别1**、**模型**.**数据2.级别2** 和**模型**.**数据2.级别3**。 可以在将调用这个新计算字段的位置中指定所需征税级别。

1. 在配置树中，展开**用于了解参数化调用的模型**项的内容。
2. 选择**用于了解参数化调用的格式**。
3. 选择**创建配置**。
4. 选择**从以下名称派生: 用于了解参数化调用的格式, Microsoft**。
5. 在**名称**字段中，输入**用于了解参数化调用的格式(自定义)**。
6. 选择**创建配置**。

## <a name="configure-a-parameterized-calculated-field-that-returns-a-list-of-records"></a>配置用于返回记录列表的参数化计算字段

### <a name="start-adding-a-new-calculated-field"></a>开始添加新的计算字段

1. 选择**设计器**。
2. 选择**展开/折叠**以展开所有格式项。
3. 选择**映射**。
4. 展开**模型**项。
5. 选择**模型.数据2** 项。
6. 选择**添加**。
7. 选择**函数\\计算字段**。
8. 在**名称**字段中，输入**级别**。
9. 选择**编辑公式**。

### <a name="define-a-parameter-for-adding-a-calculated-field"></a>定义用于添加计算字段的参数

1. 选择**参数**。
2. 选择**新建**。
3. 在**名称**字段中，输入**征税级别**。
4. 在**类型**字段中，选择**字符串**。

    只有原始数据类型才能用于指定参数的自变量类型。 因此，**记录列表**、**记录**和**枚举**类型不能用于此用途。

    为一个计算字段最多可以指定 8 个参数。

    ![参数数据源列表](media/er-calculated-field-type-05.png)

5. 选择**确定**。

可以通过添加此参数来指定调用此计算字段所需条件。 调用此计算字段时，需要将**征税级别**参数的自变量指定为**字符串**格式的值。

   请确保仅为容器中包含的计算字段（**记录列表**、**记录**或**容器**）定义参数。

   将在此计算字段的数据源列表中提供配置的参数。 可通过选择**添加数据源**向配置的表达式添加参数。

   ![数据源字段](media/er-calculated-field-type-06.png)

### <a name="define-an-expression-for-adding-a-calculated-field"></a>定义用于添加计算字段的表达式

1. 在**公式**字段中，输入： 

    **WHERE(\@.摘要2, \@.摘要2.分组.级别 =**
    
2. 在数据源列表中选择**征税级别**参数。
3. 选择**添加数据源**。
4. 在**公式**字段中，设置如下表达式：  

    **WHERE(\@.摘要2, \@.摘要2.分组.级别 = '征税级别')**

5. 选择**保存**。

    ![数据源字段信息](media/er-calculated-field-type-07.png)

6. 关闭**公式设计器**页。

### <a name="finish-adding-a-new-calculated-field"></a>完成添加新的计算字段

- 选择**确定**。

在**格式设计器**页面中，配置的参数化计算字段**级别**需要一个**字符串**自变量。

![展开的计算字段级别列表](media/er-calculated-field-type-08.png)

### <a name="use-the-configured-calculated-field-for-binding-format-elements"></a>对绑定格式元素使用配置的计算字段

1. 选择**模型.数据2.级别**以选择配置的计算字段。
2. 选择**报.税.正常**格式元素。
3. 选择**绑定**。
4. 选择**是**以确认在所选格式元素的所有嵌套格式元素中，将当前使用的数据源**级别1** 替换为新数据源**级别**。

    应用的绑定已构建为参数化计算字段的一个调用。 在以下情况下，绑定格式元素的名称默认用作参数化计算字段的自变量：

      - 计算字段配置为使用单个参数。
      - 此参数的数据类型定义为**字符串**。

    如果绑定格式元素的名称为空，则在应用的绑定中使用此元素的数据源名称。

5. 选择**报.税.减税**格式元素。
6. 选择**绑定**。
7. 选择**是**以确认在所选格式元素下的所有嵌套格式元素中，将当前使用的数据源**级别2** 替换为新数据源**级别**。
8. 选择**报.税.免税**格式元素。
9. 选择**绑定**。
10. 选择**是**以确认在所选格式元素下的所有嵌套格式元素中，将当前使用的数据源**级别3** 替换为新数据源**级别**。

   为表示征税级别的 XML 元素指定参数化计算字段的自变量时（例如，**模型.数据2.级别("减税")** 作为文本值），则无需对嵌套的 XML 属性执行z相同操作 — 其绑定将自动继承在父级别（**模型.数据2.级别.聚合.基数**，而不是**模型.数据2.级别("减税").聚合.基数**）定义的自变量的值。

不支持重复调用任何参数化计算字段。

您在选择的绑定中，可以选择 **编辑配方**和更改将参数化的计算字段的应用由默认参数。 如果缺少此自变量，可能导致运行时出错 — 在验证当前格式时通知用户此类情况。

![验证警告通知](media/er-calculated-field-type-10.png)

## <a name="configure-a-parameterized-calculated-field-to-return-a-record"></a>配置参数化计算字段以返回记录
如果参数化计算字段返回记录，您需要支持将此记录的单个字段绑定到格式元素。 在此类情况下，不存在包含用于调用参数化计算字段的自变量的值的父绑定 — 必须在单个记录的字段的绑定中定义该值。

### <a name="start-adding-a-new-calculated-field"></a>开始添加新的计算字段

1. 选择**模型.数据2** 项。
2. 选择**添加**。
3. 选择**函数\\计算字段**。
4. 在**名称**字段中，输入**级别记录**。
5. 选择**编辑公式**。

### <a name="define-a-parameter-for-adding-a-calculated-field"></a>定义用于添加计算字段的参数

1. 选择**参数**。
2. 选择**新建**。
3. 在**名称**字段中，输入**征税级别**。
4. 在**类型**字段中，选择**字符串**。
5. 选择**确定**。

### <a name="define-an-expression-for-adding-a-calculated-field"></a>定义用于添加计算字段的表达式

1. 在**公式**字段中，输入以下内容：  
    
    **FIRSTORNULL(\@.级别(**

2. 选择**征税级别**参数。
3. 选择**添加数据源**。
4. 在**公式**字段中，将 **'征税级别'))** 追加到在步骤 1 中输入的内容后，以便将表达式设置为：  
    
    **FIRSTORNULL(\@.级别('征税级别'))**

5. 选择**保存**。
6. 关闭**公式设计器**页。

### <a name="finish-adding-a-new-calculated-field"></a>完成添加新的计算字段

-   选择**确定**。

### <a name="use-the-configured-calculated-field-to-bind-format-elements"></a>使用配置的计算字段绑定公式元素

1. 展开**模型.数据2.级别记录**以选择配置的计算字段。
2. 展开配置的计算字段的**模型.数据2.级别记录.聚合**容器。
3. 选择**模型.数据2.级别记录.聚合.基数**字段。
4. 选择**报.税.免税**格式元素。
5. 选择**取消绑定**。
6. 选择**报.税.免税.基数**格式元素。
7. 选择**绑定**。
8. 选择**编辑公式**。
9. 将表达式更改为**模型.数据2.级别记录("免税").聚合.基数**。

![更新后的表达式](media/er-calculated-field-type-11.png)

## <a name="remove-calculated-fields-that-are-not-used"></a>删除不使用的计算字段

1. 选择**模型.数据2.级别1**。
2. 选择**删除**。
3. 选择**模型.数据2.级别2**。
4. 选择**删除**。
5. 选择**模型.数据2.级别3**。
6. 选择**删除**。
7. 选择**保存**。

  > [!NOTE]
  > 您在格式绑定中多次重复使用了同一个计算字段**模型.数据2.级别**。 使用和维护单个计算字段而不是对多个相似字段执行此操作容易得多。

8. 关闭**格式设计器**页。

## <a name="complete-adjusted-version-of-a-derived-format"></a>完成调整后的派生格式版本

1. 在**版本**快速选项卡中，选择**更改状态**。
2. 选择**完成**。

## <a name="export-completed-version-of-a-derived-format"></a>导出完成的派生格式版本

1. 在配置树中选择**用于了解参数化调用的格式(自定义)** 格式。
2. 在**版本**快速选项卡中，选择已完成版本 1.1.1。
3. 选择**交换**。
4. 选择**导出为 XML 文件**。
5. 将下载的配置以 XML 格式存储在本地。

## <a name="test-er-formats"></a>测试 ER 格式 
可运行初始 ER 格式和改进的 ER 格式以确保配置的参数化计算字段正确工作。

### <a name="import-er-configurations"></a>导入 ER 配置
可通过使用 **RCS** 类型的 ER 存储库从 RCS 导入已审查的配置。 如果已经执行了[从 Regulatory Configuration Service 导入电子申报配置](rcs-download-configurations.md)主题中的步骤，请使用配置的 ER 存储库将本主题前文讨论的配置导入到您的环境中。 否则，请执行以下步骤：

1. 选择 **DEMF** 公司，然后在默认仪表板中选择**电子申报**。
2. 选择**申报配置**。
3. 按照以下顺序从 Microsoft 下载中心导入配置：数据模型、元数据、模型映射、格式。 为每个 ER 配置完成以下步骤：

    1. 选择**交换**。
    2. 选择**从 XML 文件加载**。
    3. 选择**浏览**以选择 XML 格式的所需 ER 配置。
    4. 选择**确定**。

4. 导入从 RCS 导出的**用于了解参数化调用的格式(自定义)** 格式的已完成版本 1.1.1：

    1. 选择**交换**。
    2. 选择**从 XML 文件加载**。
    3. 选择**浏览**以选择本地存储的 XML 格式的**用于了解参数化调用的格式(自定义)** 文件。
    4. 选择**确定**。

### <a name="run-er-formats"></a>运行 ER 格式

1. 在配置树中，展开**用于了解参数化调用的模型**项的内容。
2. 选择**用于了解参数化调用的格式**。
3. 在最上面的功能区中选择**运行**。
4. 保存本地生成的输出。
5. 选择**用于了解参数化调用的格式(自定义)** 项。
6. 在最上面的功能区中选择**运行**。
7. 将生成的输出保存到本地。 
8. 比较生成的输出的内容。

## <a name="additional-resources"></a>其他资源
[电子报告中的配方设计器](general-electronic-reporting-formula-designer.md)
