---
title: 电子消息
description: 此主题提供 Microsoft Dynamics 365 for Finance and Operations 中电子消息的概述和设置信息。
author: ShylaThompson
manager: AnnBe
ms.date: 11/16/2018
ms.topic: article
ms.prod: ''
ms.service: dynamics-ax-applications
ms.technology: ''
audience: Application User
ms.reviewer: shylaw
ms.search.scope: Core, Operations
ms.search.region: Global
ms.author: shylaw
ms.search.validFrom: 2018-10-28
ms.dyn365.ops.version: 8.0999999999999996
ms.openlocfilehash: 5326642553c7efcebc6c6af953e2dafe9e62e9ec
ms.sourcegitcommit: f6fc90585632918d9357a384b27028f2aebe9b5a
ms.translationtype: HT
ms.contentlocale: zh-CN
ms.lasthandoff: 03/11/2019
ms.locfileid: "832187"
---
# <a name="electronic-messaging"></a>电子消息

[!include [banner](../includes/banner.md)]

此主题提供 Microsoft Dynamics 365 for Finance and Operations 中电子消息的概述和设置信息。

最近，全世界各个国家和地区的政府与立法机构对在这些国家或地区注册的公司实施了报告要求。 要求的目的是支持数据以电子格式从这些公司、直接从具有、存储和处理数据的系统获取。

Finance and Operations 中的电子消息功能支持在 Finance and Operations 与政府和立法机构为报告、提交和接收官方信息提供的系统之间进行各种电子互操作流程。

电子消息功能已与**电子报告** (ER) 模块集成。 因此，您可以为电子消息设置 ER 格式。 有关详细信息，请参阅[电子报告 (ER)](https://docs.microsoft.com/en-us/dynamics365/unified-operations/dev-itpro/analytics/general-electronic-reporting)。

电子消息基于以下实体：

- **电子消息** – 应该在内部报告和/或传输的报表或申报。 示例是发送给税务局的报表。
- **电子消息项** – 应包括在报告的消息中的记录。
- **电子消息处理** – 应运行以收集所需的数据、生成报表、在 Microsoft Azure Blob 存储中存储数据、在系统之外传输报表、从系统外部获取响应以及基于收到的信息更新数据库的行动链（链接或未链接）。

下图显示电子消息的数据流。

![电子消息数据流](media/electronic-messaging-data-flow.png)

电子消息功能支持以下场景：

- 手动创建消息和生成基于不同类型的关联导出 ER 格式的报表：Microsoft Excel、XML、JavaScript Object Notation (JSON)、PDF、文本和 Microsoft Word。
- 自动创建和处理基于通过关联导入 ER 格式从当局请求和获取的信息的消息。
- 作为消息项收集和处理来自数据源（Finance and Operations 表）的信息。
- 存储附加信息，并通过调用有关消息或消息项的专门定义的可执行类评估不同值。
- 聚合在消息项中收集的信息，按消息拆分该信息，然后生成关联导出 ER 格式的报表。
- 传输使用存储在 Azure Key Vault 中的安全信息生成到 Web 服务的报表。
- 从 Web 服务获取响应、解释响应、根据需要更新 Finance and Operations 中的数据。
- 存储和查看生成的所有报表。
- 存储和查看与为消息或消息项运行的行动有关的所有日志信息。
- 通过各个消息状态和消息项状态控制处理。

## <a name="set-up-electronic-messaging"></a>设置电子消息

电子消息可以帮助您维护不同文档类型的不同电子报告流程。 在一些复杂的场景中，电子消息被设置为包含很多消息状态、消息项状态、行动、额外字段和可执行类的组合。 对于这些场景，数据实体包可以导入。 如果您使用这些数据实体包，您应使用数据管理工具将其导入到法人。 有关如何使用数据管理工具的详细信息，请参阅[数据管理](../../dev-itpro/data-entities/data-entities-data-packages.md)。

如果您不导入数据实体包，您可以手动设置电子消息功能。 在这种情况下，必须设置以下元素： 

- [编号规则](#number-sequences)
- [消息项类型和状态](#message-item-types-and-statuses)
- [消息状态](#message-statuses)
- [附加字段](#additional-fields)
- [可执行类设置](#executable-class-settings)
- [填充记录行为](#populate-records-actions)
- [Web 应用程序](#web-applications)
- [Web 服务设置](#web-service-settings)
- [消息处理操作](#message-processing-actions)
- [电子消息处理](#electronic-message-processing)

以下部分提供有关每个元素的详细信息。

### <a name="number-sequences"></a>编号规则

为消息和消息项设置编号规则。 编号规则用于自动对消息和消息项编号，分配的编号将用作系统中消息和消息项的唯一标识符。 您可以在**总帐参数**页（**总帐** \> **分类帐设置** \> **总帐参数**）上为电子消息设置编号规则。

### <a name="message-item-types-and-statuses"></a>消息项类型和状态

消息项类型标识将在电子消息中使用的记录的类型。 您可以在**消息项类型**页（**税** \> **设置** \> **电子消息** \> **消息项类型**）设置消息项类型。

消息项状态标识将应用于您正在设置的处理中的消息项的状态。 您可以在**消息项状态**页（**税** \> **设置** \> **电子消息** \> **消息项状态**）设置消息项类型。

消息项状态的**允许删除**参数定义是否允许用户通过**电子消息**窗体或**电子消息项**窗体删除此状态的消息项。 

### <a name="message-statuses"></a>消息状态

设置应该在消息处理中呈现的消息状态。 您可以在**消息状态**页（**税** \> **设置** \> **电子消息** \> **消息状态**）设置消息状态。

字段说明：

| 字段名称           | 说明 |
|----------------------|-------------|
|消息状态        | 电子消息状态的唯一名称，用于描述消息在各时刻的状态。 此名称在电子消息窗体中和与电子消息有关的日志中显示。 |
|说明           | 与电子消息状态有关的说明      |
|响应类型         | 处理中的某些操作可能生成多种响应类型。 例如，**Web 服务**类型的操作可能生成**已成功执行**或**技术错误**响应类型，具体取决于其执行结果。 在此案例中，必须同时定义这两种响应类型的消息状态。 有关操作类型及相关响应类型的详细信息，请参阅[消息处理操作类型](#message-processing-action-types)。 |
|消息项状态   |有时电子消息状态必须相应影响相关消息项的状态。 请关联此类消息项状态，方法是在查找中选择该状态。 |
|允许删除          | 电子消息状态的**允许删除**参数定义是否允许用户通过**电子消息**窗体删除此状态的电子消息。            |

### <a name="additional-fields"></a>附加字段

电子消息功能让您可以填充交易表中的记录。 这样，您可以为报告准备记录，然后报告它们。 有时，交易表中没有足够的信息来根据报表要求报告记录。 您可以通过设置附加字段来填写必须为记录报告的所有信息。 附加字段可与消息和消息项关联。 您可以在**附加字段**页（**税** \> **设置** \> **电子消息** \> **附加字段**）设置附加字段。

下表描述**附加字段**页的常规字段。

| 字段                | 说明 |
|----------------------|-------------|
| 字段名称           | 输入与此流程相关的消息项的其他属性的名称。 在处理流程时，此名称显示在用户界面中。 它还可以用于与流程相关的 ER 配置。 |
| 说明          | 输入与此流程相关的消息项的其他属性的描述。 |
| 用户编辑            | 如果用户必须可以更改用户界面中的额外字段的值，请将此复选框设置为**是**，否则设置为**否**。 |
| 计数器              | 当额外字段中必须包含电子消息内的序列号时，请选中此复选框。 运行“电子报告导出”类型的操作期间，将自动填写额外字段的值。  |
| 隐藏               | 如果必须在用户界面中隐藏这个额外字段，请选中此复选框。  |

对于此项处理，每个额外字段都可能有不同的值。 可以通过“值”快速选项卡定义这些值：

| 字段                | 说明 |
|----------------------|-------------|
| 字段值          | 在报告过程中输入要使用的与消息或消息项相关的字段值。 |
| 字段描述    | 在报告过程中输入要使用的与消息或消息项相关的字段值的描述。 |
| 科目类型         | 有些附加字段值可能被限制为特定科目类型。 选择以下值之一：**所有**、**客户**或**供应商**。 |
| 帐户编码         | 如果您在**科目类型**字段中选择了**客户**或**供应商**，您可以进一步将字段值的使用限定为特定组或表。 |
| 帐户/组编号 | 如果您在**科目类型**字段中选择了**客户**或**供应商**，并且如果您在**帐户编码**字段中输入了组或表，您可以在此字段中输入特定组或票务代理。 |
| 生效            | 指定应该开始考虑值的日期。 |
| 到期           | 指定应该停止考虑值的日期。 |

默认情况下，**帐户/组编号**、**帐户编码**、**生效**、**到期**中定义的条件组合影响选择的额外字段值，但是可以在可执行类中用于实施额外字段值的某些特定计算逻辑。

### <a name="executable-class-settings"></a>可执行类设置

可执行类是一个 X++ 方法或类，如果流程需要一些评估，电子消息处理可以对行动调用它。

您可以在**可执行类设置**页（**税** \> **设置**\> **电子消息** \> **可执行类设置**）手动设置可执行类。 创建行，并设置以下字段。

| 字段                 | 说明 |
|-----------------------|-------------|
| 可执行类      | 输入将在设置此类为其调用的消息处理行动期间使用的名称。 |
| 说明           | 输入可执行类的描述。 |
| 可执行类名称 | 选择 X++ 可执行类。 |
| 执行级别       | 因为应为选择的可执行类预定义此字段，因此此字段将自动设置。 此字段限制相关评估运行的级别。 |
| 类描述     | 因为应为选择的可执行类预定义此字段，因此此字段将自动设置。 |

某些可执行类可能有必需参数，必须在首次运行该可执行类之前定义。 若要定义此类参数，请单击“操作”窗格中的**参数**按钮，设置对话窗口中的相应值和字段，然后单击**确定**按钮。 此处务必单击**确定**按钮，否则将不会把参数保存到库，从而不能正确调用可执行类。

### <a name="populate-records-actions"></a>填充记录行为

您使用填充记录操作设置将记录添加到消息项表以使其可以添加到电子消息的操作。 例如，如果您的电子消息必须报告客户发票，则必须设置在**客户发票日记帐**表中链接的**填充记录**操作（在**数据源**字段中）。 您可以在**填充记录行动**页（**税** \> **设置**\> **电子消息** \> **填充记录行动**）设置填充记录行动。 为应将记录添加到表的每个操作创建新记录，然后设置以下字段。

| 字段       | 说明                                                               |
|-------------|---------------------------------------------------------------------------|
| 姓名        | 为在您的流程中填充记录的操作输入名称。       |
| 说明 | 输入在您的流程中填充记录的操作的描述。 |

在**数据源设置**快速选项卡上，为用于流程的每个数据源添加一个行，并设置以下字段。

| 字段                  | 说明 |
|------------------------|-------------|
| 姓名                   | 输入数据源的名称。 |
| 消息项类型      | 选择在为数据源创建记录时应使用的消息项的类型。 |
| 科目类型           | 选择应与来自数据源的记录关联的科目的类型。 |
| 主表名称      | 选择应是数据源的 Finance and Operations 中的表。 |
| 单据编号字段  | 在所选表中选择应从中获取单据编号的字段。 |
| 单据日期字段    | 在所选表中选择应从中获取单据日期的字段。 |
| 文档帐户字段 | 在所选表中选择应从中获取单据科目的字段。 |
| 用户查询             | 如果选中此复选框，则可以通过选择网格上方的**编辑查询**来设置查询。 否则，所有记录将从数据源填充。 |

### <a name="web-applications"></a>Web 应用程序

可使用 Web 应用程序页面设置 Web 应用程序的参数，以便支持开放标准 OAuth 2.0，后者用于供用户在不共享自己的访问凭证的情况下，为该应用程序授予代表自己的“安全委托访问权限”。 也可以通过此页面获取授权码和访问令牌来了解授权流程。 您可以在 **Web 应用程序**页（**税** \> **设置** \> **电子消息** \> **Web 应用程序**）设置 Web 应用程序设置。

下表描述 **Web 应用程序**页的字段。

| 字段                         | 说明 |
|-------------------------------|-------------|
| 应用程序名称              | 为 Web 应用程序输入名称。 |
| 说明                   | 输入 Web 应用程序的描述。 |
| 基 URL                      | 输入 Web 应用程序的基 Internet 地址。 |
| 授权 URL 路径        | 指定构成用于进行授权的 URL 的路径。  |
| 令牌 URL 路径                | 指定构成令牌的 URL 的路径。  |
| 重定向 URL                  | 输入重定向 URL。  |
| 客户端 ID                     | 输入 Web 应用程序的客户端 ID。  |
| 客户端密钥                 | 输入 Web 应用程序的客户端密钥。  |
| 服务器令牌                  | 输入 Web 应用程序的服务器令牌。  |
| 授权格式映射  | 选择要用于生成授权请求的电子申报 (ER) 格式。   |
| 导入令牌模型映射    | 选择要用于存储访问令牌的 ER 导入模型。  |
| 授予的范围      访问令牌的到期前时间  | 此字段将自动更新。 其值显示授予的 Web 应用程序请求范围。  |
| 接受                        | 指定 Web 请求接受属性。 例如，“application/vnd.hmrc.1.0+json”。  |
| 内容类型           | 指定内容类型。 例如，“application/json”。  |

**Web 应用程序**中提供以下功能为授权流程提供支持：
-   **获取授权代码** - 初始化 Web 应用程序的授权。
-   **获取访问令牌** - 初始化访问令牌的获取。
-   **刷新访问令牌** - 刷新访问令牌。

可将以加密格式存储在系统数据库中的 Web 应用程序访问令牌用于请求 Web 服务。 出于安全目的，只有必须允许解决这些请求的安全角色才能访问这些访问令牌。 当不属于该安全组的用户尝试解决请求时，将通过异常来通知该用户不允许其通过所选 Web 应用程序进行互操作。
请使用“税 > 设置 > 电子消息 > Web 应用程序“页的**安全角色**快速选项卡设置必须可以访问访问令牌的角色。 如果不为 Web 应用程序定义安全角色，则只有系统管理员可以通过此 Web 应用程序互操作。

### <a name="web-service-settings"></a>Web 服务设置

您使用 Web 服务设置对传输到 Web 服务的直接数据传输进行设置。 您可以在 **Web 服务设置**页（**税** \> **设置** \> **电子消息** \> **Web 服务设置**）设置 Web 服务设置。

下表描述 **Web 服务设置**页的字段。

| 字段                   | 说明 |
|-------------------------|-------------|
| Web 服务             | 为 Web 服务输入名称。 |
| 说明             | 输入 Web 服务的描述。 |
| Internet 地址        | 输入 Web 服务的 Internet 地址。 如果为 Web 服务指定了 Web 应用程序，并且 Internet 地址应该与为所选 Web 应用程序定义的相同，则请单击**复制基 URL** 按钮将**基 URL** 从 Web 应用程序复制到 Web 服务的 **Internet 地址**字段。  |
| 证书             | 选择此前设置的密钥保管库证书。 |
| Web 应用程序         | 选择此前设置的密钥保管库证书。 |
| 响应类型 - XML | 如果响应类型是 XML，将此选项设置为**是**。 |
| 请求方法          | 指定请求的方法。 HTTP 定义指示应该为给定资源执行的操作的一组请求方法。 方法可以是 **GET**、**POST**，或其他 HTTP 方法。 |
| 请求标题         | 指定请求标题。 请求标题是可以在 HTTP 请求中使用但与消息内容不相关的 HTTP 标题。 |
| 接受                  | 指定 Web 请求接受属性。 |
| 接受编码         | 指定接受编码。 接受编码请求 HTTP 标题给予客户可以了解的内容编码的建议。 此内容编码通常是压缩算法。 |
| 内容类型            | 指定内容类型。 内容类型实体标题指示资源的媒体类型。 |
| 成功的响应代码   | 指定用于指示请求已成功的 HTTP 状态代码。 |
| 请求标题格式映射  | 选择 ER 格式以生成 Web 请求标题。 |

### <a name="message-processing-actions"></a>消息处理操作

您使用消息处理操作创建流程的操作和设置操作参数。 您可以在**消息处理操作**页（**税** \> **设置** \> **电子消息** \> **消息处理操作**）设置消息处理操作。

下表描述**消息处理操作**页的字段。

#### <a name="general-fasttab"></a>常规快速选项卡

| 字段                   | 说明 |
|-------------------------|-------------|
| 操作类型             | 选择操作的类型。 有关可用选项的信息，请参阅[消息处理操作类型](#message-processing-action-types)部分。 |
| 格式映射          | 选择应为操作调用的 ER 格式。 此字段仅可用于**电子报告导出**、**电子报告导入**、**电子报告导出消息**类型的操作。 |
| URL 路径的格式映射 | 选择应为操作调用的 ER 格式。 此字段仅适用于 **Web 服务**类型的操作，用于构成将添加到为所选 Web 服务器指定的基 Internet 地址的 URL 地址的路径。 |
| 消息项类型       | 选择应为其评估操作的记录的类型。 此字段可用于**消息项执行级别**、**电子报告导出**、**电子报告导入**、**Web 服务**以及其他一些类型的操作。 如果将此字段留空，为消息处理定义的所有消息项类型都将进行评估。 |
| 可执行类        | 选择以前创建的可执行类设置。 此字段仅可用于**消息项执行级别**和**消息项执行级别**类型的操作。 |
| 填充记录行为 | 选择此前设置的填充记录操作。 此字段仅可用于**填充记录**类型的操作。 |
| Web 服务  | 选择此前设置的 Web 服务。 此字段仅可用于 **Web 服务**类型的操作。  |
| 文件名  | 指定将因为响应 Web 服务器或生成报告而生成操作的文件的名称。 此操作仅适用于 **Web 服务**和**电子报告导出消息**类型的操作。   |
| 显示对话框  | 如果必须在生成报告之前向用户显示对话框，请选中此复选框。 此操作仅适用于**电子报告导出消息**类型的操作。   |

##### <a name="message-processing-action-types"></a>消息处理操作类型

**操作类型**字段中具有以下选项：

- **创建消息** – 使用此类型允许用户在**电子消息**页手动创建消息。 无法为此类型的操作设置初始状态。
- **填充记录** – **填充记录**操作必须在以前设置。 将其与**填充记录**类型的操作关联以使其包括在处理中。 假设此操作类型用于消息处理中的第一个操作（当未提前创建电子消息时），或用作向之前创建的消息（通过**创建消息**类型的操作）添加消息项这一操作。 因此，只能为此类型的操作设置仅消息项的结果状态。 只能为消息设置初始状态。
- **消息执行级别** – 使用此类型设置应在消息级别评估的可执行类。
- **消息项执行级别** – 使用此类型设置应在消息项级别评估的可执行类。
- **电子报告导出** – 为应基于消息项级别的导出 ER 配置生成报表的操作使用此类型。
- **电子报告导出消息** – 为应基于消息级别的导出 ER 配置生成报表的操作使用此类型（例如，当消息不包含任何消息项时）。
- **电子报告导入** – 为应基于导入 ER 配置生成报表的操作使用此类型。
- **消息级别用户处理** – 为假定一些用户手动操作的操作使用此类型。 例如，用户可能更新消息的状态。
- **用户处理** – 为假定一些用户手动操作的操作使用此类型。 例如，用户可能更新消息项的状态。
- **Web 服务** – 为应将生成的报表传输到 Web 服务的操作使用此类型。 此操作类型不用于“意大利采购和销售发票通信”报告。 对于 **Web 服务**类型的操作，可在**消息处理操作**的**杂项详细信息**快速选项卡上指定**确认文本**。 将在解决对所选 Web 服务的请求之前，向用户显示此确认文本。
- **请求验证** – 使用此类型从服务器请求验证。

#### <a name="initial-statuses-fasttab"></a>初始状态快速选项卡

> [!NOTE]
> **初始状态**快速选项卡不可用于具有**创建消息**初始类型的操作。

| 字段               | 说明                                                                                         |
|---------------------|-----------------------------------------------------------------------------------------------------|
| 消息项状态 | 选择应为其评估所选的消息处理操作的消息项状态。 |
| 说明         | 所选消息项状态的描述。                                                  |

#### <a name="result-statuses-fasttab"></a>结果状态快速选项卡

| 字段               | 说明 |
|---------------------|-------------|
| 消息状态      | 选择应为其评估所选的消息处理操作的消息状态。 此字段仅可用于在消息级别评估的消息处理操作。 例如，它不可用于**电子报告导出**和**电子报告导入**类型的操作。 它不可用于**用户处理**和**消息项执行级别**类型的操作。 |
| 说明         | 所选消息状态的描述。 |
| 响应类型       | 所选消息状态的响应类型。 |
| 消息项状态 | 选择应在评估所选消息处理操作后可用的生成的状态。 此字段仅可用于在消息项级别评估的消息处理操作。 例如，它可用于**用户处理**和**消息项执行级别**类型的操作。 对于在消息级别评估的消息处理操作，此字段显示为所选消息状态设置的消息项状态。 |

下表介绍必须设置与操作类型有关的哪些结果状态：

| 电子消息操作类型\响应类型  | 已成功执行  | 业务错误  | 技术错误  | 用户定义的  | 取消  |
|-------------------------------------------------|--------------|---------|-------|-----|-----------------|
| 创建消息                                  | X            |         |       |     |                 |
| 电子报告导出                     | X            |         |       |     |                 |
| 电子报告导入                     |              |         |       |     |                 |
| Web 服务                                     | X            |         | X     |     |                 |
| 用户处理                                 |              |         |       |     |                 |
| 消息执行级别                         |              |         |       |     |                 |
| 填充记录                                |              |         |       |     |                 |
| 消息项执行级别                    |              |         |       |     |                 |
| 请求验证                            | X            |  X      | X     |     |                 |
| 电子报告导出消息             | X            |         |       |     |                 |
| 消息级别用户处理                   |              |         |       |     |                 |

### <a name="electronic-message-processing"></a>电子消息处理

电子消息处理是电子消息功能的基本概念。 它聚合应为电子消息评估的操作。 操作可以通过初始状态和结果状态链接。 或者，**用户处理**类型的操作可以独立启动。 在**电子消息处理**页（**税** \> **设置** \> **电子消息** \> **电子消息处理**），还可以选择应在消息级或消息项级为处理支持的附加字段。

**操作**快速选项卡让您可以将预定义的操作添加到处理。 您可以指定是否必须单独运行操作，或者它是否可以通过处理启动。 若要定义是否只能由用户初始化操作，请在处理中为操作选中**单独运行**复选框。 如果对于定义为操作初始状态的状态的消息或消息项，希望通过处理来启动此操作，请取消选中**单独运行**参数。 **用户操作**类型的操作必须单独运行。 

有时可能需要将多项操作聚合为序列，即使其中的第一个操作定义为要单独运行。 例如，当要求必须由用户初始化报表生成，但是报表一生成，就会立即发送给 Web 服务，并且必须在系统中反映 Web 服务的响应时。 对于此类用途，可使用**不可分序列**。 方法是单击**电子消息处理**页的**操作**快速选项卡“操作”窗格中的**不可分序列**按钮，创建序列，在必须始终一起运行的操作的**不可分序列**列中选择该序列。 可将此情况中的第一个操作设置为**单独运行**，但其他所有操作不可以。

**消息项附加字段**快速选项卡让您可以添加与消息项相关的预定义附加字段。 您必须为与字段相关的每个消息项类型添加附加字段。

**消息附加字段**快速选项卡让您可以添加与消息相关的预定义附加字段。

**安全角色**快速选项卡允许您设置在进行特定处理的系统中预定义的安全角色。 具有特定角色的用户将只看到为该角色定义的处理。

**批处理**快速选项卡让您可以设置在批处理制度中执行的处理。

## <a name="work-with-electronic-messages-functionality"></a>使用电子消息功能

如果您在消息级别工作，**电子消息**页（**税** \> **查询和报表** \> **电子消息** \> **电子消息**）更有用。 如果您在数据收集（消息项）级别运行，**电子消息项**页（**税** \> **查询和报表** \> **电子消息** \> **电子消息项**）更有用。

### <a name="electronic-messages"></a>电子消息

**电子消息**页根据您的角色显示对您可用的处理。 安全角色与该处理的设置中的处理关联。 对于每个您可用的处理，此页显示电子消息和与之相关的信息。

**消息**快速选项卡显示所选处理的电子消息。 根据所选消息和预定义处理的状态，您可以通过选择网格上方的按钮运行一些操作：

- **新建** – 此按钮与**创建消息**类型的操作关联。
- **删除** – 如果选择了所选消息的当前状态的**允许删除**复选框，此按钮可用。
- **收集数据** - 此按钮与**填充记录**类型的操作关联。
- **生成报表** – 此按钮与**电子报告导出消息**类型的操作关联。
- **发送报表** – 此按钮与 **Web 服务**类型的操作关联。
- **导入响应** – 此按钮与**电子报告导入**类型的操作关联。
- **更新状态** – 此按钮与**消息级别用户处理**类型的操作关联。
- **消息项** – 打开**电子消息项**页。

**操作日志**快速选项卡显示有关为所选消息运行的所有操作的信息。 如果操作产生了错误，将在相关“操作”日志行中附加有关该错误的信息。 选择行并单击页中右上角的**剪辑**按钮可查看有关错误的信息。

**消息附加字段**快速选项卡显示为处理设置中的消息定义的所有附加字段。 它还显示这些附加字段的值。

**消息项**快速选项卡显示与所选消息相关的所有消息项。 可对各消息项使用以下功能，具体取决于此消息项的状态：

- **删除** – 如果选择了所选消息项的当前状态的**允许删除**复选框，此按钮可用。
- **更新状态** – 此按钮与**用户处理**类型的操作关联。
- **原始凭证** - 用户可通过此按钮打开包含所选消息原始凭证的页面。

您可以查看所选消息的所有附件。 这些附件是已生成并接收的报表。 选择要查看其附件的消息，然后选择操作窗格上的**附件**按钮。

![“附件”按钮](media/attachment-icon.png)

**附件**页显示与消息相关的所有附件。 若要查看文件，请在左侧列表中选择它，然后选择操作窗格上的**打开**。

![“打开”按钮](media/open-button.png)

若要查看与以前为消息运行的特定操作相关的附件，请选择**电子消息**页上的消息，然后，在**操作日志**快速选项卡上，选择该操作。 然后选择操作窗格上的**附件**按钮。

您还可以通过选择操作窗格上的**运行处理**运行整个处理或特定操作。

### <a name="electronic-message-items"></a>电子消息项

**电子消息项**页显示所有消息项，以及为每个消息项运行的操作的日志。 它还显示为消息项定义的附加字段，以及这些附加字段的值。

下表描述**消息项**选项卡的字段。

<table>
<thead>
<tr>
<th>字段</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>处理中</td>
<td>用于创建消息项的处理的名称。</td>
</tr>
<tr>
<td>消息项</td>
<td>消息项的 ID。 此 ID 基于在<strong>总帐参数</strong>页定义的<strong>消息项</strong>编号规则自动分配。</td>
</tr>
<tr>
<td>消息项日期</td>
<td>创建消息项的日期。</td>
</tr>
<tr>
<td>消息项类型</td>
<td>消息项的类型。 可以为同一个处理设置多个消息项类型（例如，<strong>传入发票</strong>和<strong>传出发票</strong>）。 只有当发票被添加到消息项表时，此字段才会自动填充。</td>
</tr>
<tr>
<td>消息项状态</td>
<td>消息项的实际状态。 可用状态随消息项类型而变化。 下面举了一些示例加以说明：
<ul>
<li><strong>已填充</strong> – 记录已添加到消息项表中。</li>
<li><strong>已评估</strong> – 已为消息项计算其他属性。</li>
<li><strong>已报告</strong> – 消息项已成功添加到报表中。</li>
<li><strong>已排除</strong> – 如果您必须在导出报表前从报表中排除一些消息项，此状态可能有用。</li>
</ul>
</td>
</tr>
<tr>
<td>传输日期</td>
<td>对于在系统外自动传输生成的报表的处理，为传输消息项的日期。</td>
</tr>
<tr>
<td>文档编号</td>
<td>此字段基于填充记录操作的设置自动填充。 只有当发票被添加到消息项表时，此字段才会自动填充。</td>
</tr>
<tr>
<td>帐号</td>
<td>客户或供应商的帐号（或其他字段值，根据在<strong>填充记录</strong>操作上定义的字段）。 只有当发票被添加到消息项表时，此字段才会自动填充。</td>
</tr>
<tr>
<td>消息</td>
<td>消息的编号。 此编号基于在<strong>总帐参数</strong>页定义的<strong>消息</strong>编号规则自动分配。</td>
</tr>
<tr>
<td>消息状态</td>
<td>电子消息的实际状态。</td>
</tr>
<tr>
<td>后续操作</td>
<td>可以为消息项的当前状态启动的下一个操作。</td>
</tr>
</tbody>
</table>

**附加字段**选项卡显示所选消息项的附加字段及其值。

#### <a name="run-processing"></a>运行处理

选择操作窗格上的**运行处理**运行消息项的处理。 若要运行特定操作，在**运行处理**对话框中，将**选择操作**选项设置为**是**，然后选择操作。 若要运行整个处理，则将**选择操作**选项保留为**否**。

#### <a name="generate-report"></a>生成报表

选择操作窗格上的**生成报表**生成报表。 此按钮与**电子报告导出**类型的操作关联。

#### <a name="update-status"></a>更新状态

选择操作窗格上的**更新状态**更新一个或多个消息项的状态。 在**更新状态**对话框中，使用**要包括的记录**快速选项卡选择要更新的消息项。 请确保正确定义选择条件，因为消息项状态将根据这些条件、所选操作的初始状态以及您设置的**新状态**更新。 在完成状态更新后，将很难确定更新了哪些项目。 因此将很难回滚状态更新。

#### <a name="electronic-messages"></a>电子消息

选择操作窗格上的**电子消息**查看与所选消息项相关的电子消息。

您还可以查看与该消息项对应的所有文件。 选择消息项的**消息**字段，或选择操作窗格上的**电子消息**。 在**电子消息**页，选择要查看其报表的消息，然后选择操作窗格上的**附件**按钮。

![“附件”按钮](media/attachment-icon.png)

**附件**页显示与消息相关的所有附件。 若要查看文件，请在左侧列表中选择它，然后选择操作窗格上的**打开**。

![“打开”按钮](media/open-button.png)

#### <a name="original-document"></a>原始凭证

选择操作窗格上的**原始单据**打开所选消息项的原始单据。

## <a name="example"></a>示例

在创建您的 ER 格式后，将其映射到数据源，然后完成它，您可以使用**电子报告**工作区来运行它。 生成一个可以保存在本地的报表。

若要控制报告流程的以下方面，必须设置电子消息处理：

- 记录有关生成报表人员的信息。
- 记录报表生成时间。
- 保存为以前期间生成的报表。

本部分提供显示如何设置电子消息功能来建立报告流程的示例。

### <a name="set-up-and-run-processing-to-call-a-simple-er-exporting-format-to-generate-an-excel-report"></a>设置并运行处理以调用简单的 ER 导出格式来生成 Excel 报表

本部分提供显示如何设置电子消息以基于 Excel 的导出 ER 格式生成报表的示例。 要按此示例操作，必须已经创建了 ER Excel 导出格式，并映射到数据源并且完成。 必须为电子消息设置了编号规则。

在您创建处理时，如果您首先定义将设置的处理操作和状态将会很有用。 下图显示此示例的处理看起来如何。

![处理方案](media/processing-scheme.png)

#### <a name="create-message-statuses"></a>创建消息状态

1. 转到**税 \> 设置 \> 电子消息 \> 消息状态**。
2. 创建以下消息状态：

    - 新建
    - 已准备
    - 已生成

    ![消息状态](media/message-statuses.png)

3. 在**新**状态的行中，选择**允许删除**复选框以让用户可以删除此状态的消息。

#### <a name="create-additional-fields"></a>创建附加字段

1. 转到**税 \> 设置 \> 电子消息 \> 附加字段**。
2. 添加附加字段及其值。 下面是一个示例。

    ![附加字段](media/additional-fields.png)

3. 将**用户编辑**选项设置为**是**以允许用户编辑此字段。

#### <a name="create-message-processing-actions"></a>创建消息处理操作

对于本例，将创建以下操作：

- **创建消息**
- **更新为已准备**
- **生成报表**
- **更新为初始状态**（可选）

1. 转到**税 \> 设置 \> 电子消息 \> 消息处理操作**。
2. 创建名为**创建消息**的操作。 在**常规**快速选项卡上，在**操作类型**字段中，选择**创建消息**。
3. 创建名为**更新为已准备**的操作，然后设置以下字段：

    - 在**常规**快速选项卡上，在**操作类型**字段中，选择**消息级别用户处理**。
    - 在**初始状态**快速选项卡上，在**消息状态**字段中，选择**新**。
    - 在**结果状态**快速选项卡上，在**消息状态**字段中，选择**已准备**。 在**响应类型**字段中，输入**已成功执行**。

4. 创建名为**生成报表**的操作，然后设置以下字段：

    - 在**常规**快速选项卡上，在**操作类型**字段中，选择**电子报告导出**。 在**格式映射**字段中，选择导出 ER 格式。 选项有 **Excel**、**XML**、**JSON**、**文本**和**其他**。
    - 在**初始状态**快速选项卡上，在**消息状态**字段中，选择**已准备**。
    - 在**结果状态**快速选项卡上，在**消息状态**字段中，选择**已生成**。 在**响应类型**字段中，输入**已成功执行**。

    ![生成报表操作](media/generate-report-action.png)

5. 可选：若要使用户能够多次重新生成报表，您可以创建**更新为初始状态**操作并设置以下字段：

    - 在**常规**快速选项卡上，在**操作类型**字段中，选择**消息级别用户处理**。
    - 在**初始状态**快速选项卡上，在**消息状态**字段中，选择**已生成**。
    - 在**结果状态**快速选项卡上，在**消息状态**字段中，选择**已准备**或（和）**新**。 在**响应类型**字段中，输入**已成功执行**。

#### <a name="electronic-message-processing"></a>电子消息处理

在此示例中，应设置所有操作，以便其单独运行。 假定每个操作都将由用户初始化。

1. 转到**税 \> 设置 \> 电子消息 \> 电子消息处理**。
2. 为您的处理添加记录，添加所有先前定义的操作和附加字段。
3. 可选：在**安全角色**快速选项卡上，为您的处理定义安全角色以限制对特定报告的访问。
4. 转到**税 \> 查询和报表 \> 电子消息 \> 电子消息**。
5. 选择**新建**创建消息。 此时，您可以添加日期和描述。 您还可以根据需要更新附加字段的值。

    ![创建电子消息](media/create-electronic-message.png)

**操作日志**快速选项卡上的网格将自动填充为对消息执行的所有操作的日志。

您现在可以删除或更新消息状态。 若要更新消息状态，选择**更新状态**，然后在**新状态**字段中，选择**已准备**。 然后选择**确定**。

![更新消息状态](media/update-status.png)

消息状态更新为**已准备**，现在，您可以通过选择**生成报表**生成报表。 将生成报表，消息状态和操作日志将更新。 若要查看生成的报表，请选择操作窗格上的**附件**按钮。
