---
title: 使用功能设置
description: 本主题说明如何设置电子开票功能。
author: dkalyuzh
ms.date: 12/15/2021
ms.topic: article
ms.prod: ''
ms.technology: ''
ms.search.form: ''
audience: Application User
ms.reviewer: kfend
ms.custom: ''
ms.assetid: ''
ms.search.region: Global
ms.author: dkalyuzh
ms.search.validFrom: ''
ms.dyn365.ops.version: ''
ms.openlocfilehash: 41ffc9c7009291a55392e50c5e490d3288d122bc
ms.sourcegitcommit: ffdb6794746ffe5461f9dcf34ed8e64976d22d2d
ms.translationtype: HT
ms.contentlocale: zh-CN
ms.lasthandoff: 03/02/2022
ms.locfileid: "8371504"
---
# <a name="work-with-feature-setups"></a>使用功能设置

[!include [banner](../includes/banner.md)]

要设置电子文件的生成和其他处理步骤（例如，对文件进行数字签名、将文件提交到政府 Web 服务以及接收响应或存储文件），请为电子开票功能设置处理管道、适用性规则和变量。

设置信息被合并在 *功能设置* 概念中，可以创建、删除、调整。 对于电子发票功能的完整版本，也可以查看这些信息。

您可以根据需要创建任意数量的功能设置项目，来定义生成、处理和接收电子文件的不同场景。 虽然这些功能设置项具有独立的处理操作和执行条件，但它们是作为单个电子开票功能的一部分创建的，并继承其生命周期和部署流程。

## <a name="add-a-feature-setup"></a>添加功能设置

1. 登录到您的 Regulatory Configuration Service (RCS) 帐户。
2. 在 **全球化功能** 工作区的 **功能** 部分中，选择 **电子开票** 磁贴。
3. 在 **电子开票功能** 页面上，选择状态为 **草稿** 的电子开票功能版本。
4. 在 **设置** 选项卡上，选择 **添加**。
5. 在 **创建功能设置** 下拉对话中，在 **新** 字段组中，选择以下选项之一：
 
    - **自定义设置** – 根据设置类型，创建具有空渠道、空处理管道列表、空白适用性规则部分和一组默认变量的新功能设置。
    - **来源功能设置** – 在当前电子开票功能的范围内创建另一个功能设置的副本。

6. 如果您在上一步中选择了 **自定义设置** 选项，请输入功能设置项的名称和说明，然后在 **设置类型** 字段组中，选择以下选项之一：

    - **处理管道** – 选择此选项可以生成和处理传出电子单据。 对于此设置类型，系统会创建一个空的处理管道列表、一个空白适用性规则部分和一组默认变量。 您将无法使用传入电子单据渠道。
    - **数据渠道** – 选择此选项可以设置从定义的渠道之一接收传入电子单据并将其直接传递给 Microsoft Dynamics 365 Finance 或 Dynamics 365 Supply Chain Management 的流程，无需额外操作。 对于此设置类型，系统会为数据渠道创建预定义的参数列表、空白适用性规则部分和一组默认变量。 您将无法在处理管道中添加任何操作。
    - **数据渠道和处理管道** – 此设置类型类似于 **数据渠道** 设置类型。 但是，在将传入电子单据传递到 Finance 或 Supply Chain Management 之前，您可以在处理管道中设置其他操作。

7. 如果您在上一步中选择了 **数据渠道** 或 **数据渠道和处理管道** 选项，在 **选择数据渠道** 字段中，您必须选择要与之集成的渠道。
8. 选择 **创建**。

创建功能设置后，您可以选择 **编辑** 对其进行配置。

## <a name="edit-a-feature-setup"></a>编辑功能设置

根据功能设置的类型，您可以配置生成传出电子文件并将其提交到外部渠道，或接收传入单据并将其传递到您的 Finance 或 Supply Chain Management 应用程序的流程。

### <a name="data-channel"></a>数据渠道

*数据渠道* 会获取电子文件，然后对其进行处理或将其直接传递给 Finance 或 Supply Chain Management。 此选项对 **处理管道** 类型的功能设置不可用。

要设置数据渠道，请输入渠道的名称。 然后根据所选渠道类型定义参数。 数据渠道标识符必须引用专门为标识数据渠道而创建的变量。 它将用作 Finance 或 Supply Chain Management 中的引用。

在 **附件筛选器** 选项卡上，您应该定义一组筛选器以从渠道中获取特定文件。 如果您预期文件会具有不同的文件扩展名，或者如果文件必须根据文件名进行不同的处理，可以创建多个行。 以下是主要参数：

- **名称** – 输入系统将在处理过程中引用的文件的名称。 在 Finance 和 Supply Chain Management 应用程序中，您将能够在提交日志中查看文件。
- **筛选器** – 定义用于选择文件的筛选器。
- **可选** – 如果清除此复选框，该文件为必需。 在这种情况下，如果渠道不包含与筛选器对应的文件，系统将显示错误消息。 此参数适用于电子邮件。

如果渠道是邮箱，并且传入电子邮件包含多个附件，您可以配置规则来定义服务应如何处理附件。 此服务可以将每个附件视为单独的电子发票，也可以将一个附件视为主发票，将所有其他附件视为附加项。

### <a name="processing-pipeline"></a>处理管道

*处理管道* 是一组 *操作*，它们按顺序运行，直到成功完成。 您可以使用处理管道来设置生成电子文件和执行其他步骤的流程（例如，对文件进行数字签名、将它们提交到外部 Web 服务并分析响应，以及接收和处理传入文档）。

操作列表将会预定义。 您可以使用 **新建** 和 **删除** 按钮来指定操作组合，这些操作在逻辑上定义提交或接收文档所需的流程。

操作的顺序很重要。 您可以使用 **向上** 和 **向下** 按钮调整顺序。

每个操作都有一组可以配置或调整的参数。 特定的参数集取决于操作的类型。

- **操作** – 选择操作的类型。
- **操作名称** – 输入操作的名称。 此名称将出现在提交日志以及 Finance 和 Supply Chain Management 应用程序的消息中。
- **说明** – 提供有关流程中操作用途的更多详细信息。
- **启用重试** – 如果选中此复选框，您可以在 **重试操作** 字段中选择一个操作，并在 **重试参数** 选项卡上配置其他参数。

    如果特定操作无法运行，重试功能可让您配置服务的行为。 例如，如果您尝试连接的外部 Web 服务没有响应，您可以指定系统应重新尝试连接的次数、间隔时间以及使用处理管道中的哪个操作。

- **导出结果** – 您可以为处理管道中的 *一个* 操作选中此复选框。 然后可以从 **电子单据提交日志** 页面导出该操作在 Finance 或 Supply Chain Management 应用程序中生成的电子文件。

### <a name="applicability-rules"></a>适用性规则

*适用性规则* 是一些可配置的子句，为通过电子开票功能集运行电子开票功能提供上下文。
从 Finance 或 Supply Chain Management 提交到电子开票的业务文档不带有显式引用，该引用使电子开票功能集能够调用特定电子开票功能版本和特定功能设置项来处理提交。 但是，当业务文档配置正确时，它包含使电子开票能够确定必须选择和运行哪个电子开票功能版本和处理管道所需的元素。

适用性规则使电子开票服务能够找到必须用于处理提交的确切电子开票功能。 为了找到正确的功能，提交的业务文档中的 **上下文** 字段将与适用性规则中的子句进行匹配。

您可以通过以下方式使用适用性规则：

- 选择 **新建** 可以将新子句添加到一组适用性规则中。
- 选择 **删除** 可以删除子句。
- 选择多个记录，使用 **分组** 或 **取消分组** 按钮可以创建项目或逻辑语句的组合。 例如，选择要分组的行，然后选择 **分组子句**。 将子句分组后，一个新列将添加到网格中。 此列指定分组子句的逻辑运算符。 支持以下类型的运算符：

    - Equal
    - Not equal
    - 大于/小于
    - 大于等于/小于等于
    - Contains
    - 开头为

    > [!NOTE]
    > 取消子句分组时，请始终从最内部的分组级别开始。

### <a name="variables"></a>变量

*变量* 在您设置处理管道和操作之间的数据流时为您提供更大的灵活性。 您可以在某些操作参数中引用变量来临时存储数据或电子文件。 一些变量用于在 Finance 或 Supply Chain Management 应用程序和电子开票服务之间传递数据。

系统会默认创建一些变量。 例如，**BusinessDocumentDataModel** 变量包含 JavaScript 对象表示法 (JSON) 结构中的业务数据，该结构在提交过程中来自连接的应用程序的调用。

提供以下变量类型：

- **常数** – 用于存储用于处理管道操作的临时数据的容器。
- **从客户端** – 运行提交流程时，从 Dynamics 365 客户端获取变量的内容。
- **到客户端** – 运行提交流程时，Dynamics 365 客户端可以导入变量的内容。
- **数据类型** – 选择存储在变量中的信息的数据类型。

### <a name="parameters"></a>参数设置

**禁用业务数据减少** 选项用于优化在电子单据提交期间来自 Finance 或 Supply Chain Management 应用程序的业务数据有效负载的结构。 优化有助于减少进入电子开票服务以进一步转换为所需的电子文件的数据。 默认值为 **否**。

- **是** – Finance 或 Supply Chain Management 将发送 **发票模型** 或 **会计模型**（对于巴西）结构的 JSON 文件，该结构在 **电子报告** 模块中定义。 无论最终的电子文件结构如何，模型的所有元素都会在应用程序端填充业务数据。 模型通常包含比目标文件结构所需的更多的业务数据，在应用程序中生成这些数据可能需要更多时间。 如果您希望在一个电子开票功能和功能设置中生成不同的输出文件（这种情况很少见），此选项的值需要为 **是**。 **是** 值在您对方案、电子文件结构和业务数据完整性进行故障排除时很有用。
- **否** – Finance 或 Supply Chain Management 将在没有任何业务数据的情况下首次调用服务。 此调用的目的是获取有关电子报告 (ER) 配置的信息，该配置将用于处理管道中的电子文件转换。 此信息将返回到应用程序，应用程序使用它来确定应包含在 **发票模型** 或 **会计模型**（对于巴西）结构的 JSON 文件中的业务数据子集。 此选项的 **否** 值有助于减少应用程序提交给服务的业务数据量，因为应用程序只能提交成功生成电子文件所需的业务数据。

### <a name="validate-a-feature-setup"></a>验证功能设置

您可以运行验证来检查整个配置的一致性。 例如，如果某个操作的强制参数留空，验证会检测到这一不一致，您会收到警告消息。

- 在 **功能版本设置** 页上的操作窗格上，选择 **验证**。

## <a name="delete-a-feature-setup"></a>删除功能设置

1. 在 **电子开票功能** 页面上，选择状态为 **草稿** 的电子开票功能版本。
2. 在 **设置** 选项卡上，选择 **删除**。
3. 在出现的消息框中，选择 **是** 确认您要删除功能设置。
