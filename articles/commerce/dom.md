---
title: 分配的订单管理 (DOM)
description: 本主题将介绍 Dynamics 365 Commerce 中的“分配的订单管理 (DOM)”功能。
author: josaw1
manager: AnnBe
ms.date: 05/22/2020
ms.topic: index-page
ms.prod: ''
ms.service: dynamics-365-retail
ms.technology: ''
audience: Application User
ms.reviewer: josaw
ms.search.scope: Core, Operations, Retail
ms.custom: ''
ms.assetid: ed0f77f7-3609-4330-bebd-ca3134575216
ms.search.region: global
ms.search.industry: Retail
ms.author: josaw
ms.search.validFrom: 2018-11-15
ms.dyn365.ops.version: ''
ms.openlocfilehash: 3a83bd6e997110d107bac836abf237f99db78d99
ms.sourcegitcommit: 361050bed5e0feabd370d225ec70784fc1933258
ms.translationtype: HT
ms.contentlocale: zh-CN
ms.lasthandoff: 10/15/2020
ms.locfileid: "4013149"
---
# <a name="distributed-order-management-dom"></a>分配的订单管理 (DOM)

[!include [banner](includes/banner.md)]

在新的商业运营范例中，零售商努力提供个性化的客户参与、全渠道体验以及轻松互动。 由于提供的选择众多，无论消费者在哪里采购，他们都能获得最实惠的体验。 在很多情况下，消费者不再将价格和产品作为主要决定因素。

为了帮助提高客户体验，零售商必须实时了解其所有渠道的库存。 对所有库存采用单一、全面的视图可帮助优化订单履行、分配和配送。 因此，对零售商而言，采用和实施分配的订单管理 (DOM) 系统变得愈加迫切。

DOM 可跨复杂的系统网络和流程优化订单履行。 它依赖整个组织采用的单一、全局性库存视图来智能地管理订单，从而以更具成本效益的方式准确地履行订单。 通过提高零售商的供应链效率，DOM 可帮助零售商更好地满足客户期望。

下图显示了 DOM 系统中销售订单的生命周期。

![DOM 情景下的销售订单生命周期](./media/flow.png "DOM 情景下的销售订单生命周期")

## <a name="set-up-dom"></a>设置 DOM

1. 转到 **系统管理 \> 设置 \> 许可证配置** 。
2. 在 **Configuration keys** 选项卡中，展开 **Commerce** 节点，然后选中 **分配的订单管理** 复选框。
3. 转到 **Retail 和 Commerce \> 分配的订单管理 \> 设置 \> DOM 参数** 。
4. 在 **常规** 选项卡上，设置以下值：

    - **启用分配的订单管理** - 将此选项设置为 **是** 。
    - **确认 DOM 的必应地图使用情况** - 将此选项设置为 **是** 。

        > [!NOTE]
        > 仅当 **Commerce 共享参数** 页面（ **Retail 和 Commerce \> Headquarters 设置 \> 参数 \> Commerce 共享参数** ）的 **必应地图** 选项卡上的 **启用必应地图** 选项也设置为 **是** ，并且在 **必应地图键** 字段中输入了有效的键时，才可以将此选项设置为 **是** 。

    - **保留期(天)** - 指定 DOM 运行生成的履行计划要在系统中保留多长时间。 **DOM 履行数据删除作业设置** 批处理作业将删除在此处指定的天数之前生成的任何履行计划。
    - **拒绝期(天)** - 指定必须在多长时间之后才可以将被拒绝的订单行分配到相同位置。

5. 在 **求解器** 选项卡上，设置以下值：

    - **最大自动履行尝试次数** - 指定 DOM 引擎尝试将一个订单行代理到某个位置的次数。 如果 DOM 引擎无法在指定的尝试次数内将一个订单行代理到某个位置，则它会将该订单行标记为异常。 然后，在以后的运行中它会跳过该行，直至用户手动重置此状态。
    - **本地商店地区半径** - 输入一个值。 此字段可帮助确定位置的分组方式以及在什么情况下会被视为距离相等。 例如，如果您输入 **100** ，则履行地址的 100 英里半径范围内的每个商店或配送中心都将视为距离相等。
    - **求解器类型** - 选择一个值。 随 Commerce 发布了两种求解器类型： **生产求解器** 和 **简化求解器** 。 对于要运行 DOM 的所有机器（即，属于 DOMBatch 组的所有服务器），必须选择 **生产求解器** 。 生产求解器要求默认情况下在生产环境中许可和部署的特殊许可证密钥。 对于非生产环境，必须手动部署此许可证密钥。 要手动部署许可证密钥，请按照以下步骤操作：

        1. 在 Microsoft Dynamics Lifecycle Services 中，打开共用资产库，选择 **模型** 作为资产类型，并下载 **DOM 许可证** 文件。
        2. 启动 Microsoft Internet 信息服务 (IIS) 管理器，右键单击 **AOSService 网站** ，然后选择 **浏览** 。 随后， **\<AOS service root\>\\webroot** 下将打开一个 Windows 资源管理器窗口。 记下 \<AOS Service root\> 路径，因为在下一步中会用到。
        3. 复制 **\<AOS Service root\>\\PackagesLocalDirectory\\DOM\\bin** 目录中的配置文件。
        4. 转到 Headquarters 客户端，然后打开 **DOM 参数** 页面。 在 **求解器** 选项卡上的 **求解器类型** 字段中，选择 **生产求解器** ，并确认未显示错误消息。

        > [!NOTE]
        > 提供了简化求解器，这样零售商无需部署特殊许可证即可试用 DOM 功能。 组织不应在生产环境中使用简化求解器。
        >
        > 尽管简化求解器与生产求解器提供相同的功能集，但在性能（一次运行中可以处理的订单和订单行数）和结果汇聚（在某些情况下，一批订单可能不会产生最佳结果）方面存在限制。
     
6. 返回 **Retail 和 Commerce \> 分配的订单管理 \> 设置 \> DOM 参数** 。
7. 在 **编号规则** 选项卡上，为各个 DOM 实体分配所需的编号规则。

    > [!NOTE]
    > 在为实体分配编号规则之前，必须在 **编号规则** 页面（ **组织管理 \> 编号规则 \> 编号规则** ）中定义编号规则。

8. DOM 功能支持定义各种类型的 DOM 规则，组织可以根据其业务需求配置多个规则。 可以为一组位置或单个位置以及特定的产品类别、产品或变型定义 DOM 规则。 要创建 DOM 规则必须使用的位置分组，请按照以下步骤操作：

    1. 转到 **Retail 和 Commerce \> 渠道设置 \> 履行组** 。
    2. 选择 **新建** ，然后为新组输入名称和说明。
    3. 选择 **保存** 。
    4. 选择 **添加行** ，将单个位置添加到组中。 或者，选择 **添加多行** 以添加多个位置。
    
    > [!NOTE]
    > 在 Commerce 版本 10.0.12 及更高版本中，必须在 **功能管理** 工作区中启用 **用于在履行组中将位置指定为已启用的“装运”或“提货”的功能** 。
    >
    > 此功能将在 **履行组** 页面上添加新的配置，这样您可以定义能否将仓库用于装运，或者能否将仓库/商店组合用于装运、提货或同时用于二者。 
    >
    > 如果启用此功能，则在 POS 中创建提货或装运订单时，可用于位置选择的选项将会更新。
    >
    > 如果选择了“全部装运”或“装运所选产品”操作，则启用此功能后还会刷新 POS 中的页面。

9. 要定义规则，请转到 **Retail 和 Commerce \> 分配的订单管理 \> 设置 \> 管理规则** 。 当前支持以下 DOM 规则：

    - **最小库存量规则** - 此规则类型允许组织将特定数量的产品限定用于订单履行之外的用途。 例如，组织可能不希望 DOM 考虑将商店中可用的所有库存用于订单履行。 而是，他们可能需要保留一些库存给散客。 在使用此规则类型时，可以根据位置或位置组为某类产品、单个产品或产品变型定义要保留的最小库存量。
    - **履行库位优先级规则** - 此规则类型允许组织定义位置层次结构，以确定在 DOM 引擎尝试为特定产品标识履行位置时将考虑的优先级。 优先级的有效范围为从 1 至 10，其中 1 为最高优先级，10 为最低优先级。 相对于具有较低优先级的位置，将会先考虑具有较高优先级的位置。 如果将规则定义为硬性约束规则，订单将会仅代理到定义了优先级的位置。
    - **部分订单数规则** - 此规则允许组织定义是否可以部分履行订单或订单行。 提供了以下参数：

        - **履行部分订单?** - 如果此选项设置为 **是** ，则 DOM 可以仅履行订单行上数量的一部分。 通过拆分订单行可实现此部分履行。
        - **履行部分行?** - 如果此选项设置为 **是** ，则 DOM 可以履行订单行数量的一部分。 通过拆分订单行可实现此部分履行。
        - **仅从一个位置履行订单** - 如果此选项设置为 **是** ，DOM 确保将从单个位置履行订单上的所有行。


        下表解释了定义这些参数的组合时的行为。

        | 组合编号 | 履行部分订单 | 履行部分行 | 仅从一个位置履行订单 | 说明 |
        |------|------------------------|-----------------------|--------------------------------------|-------------|
        | 1    | 是                    | 是                   | 是                                  | 可以履行订单的几行，可以部分履行各行，但在 DOM 运行实例中，所有行必须来自同一位置。 （当前不支持此组合。） |
        | 2    | 是                    | 否                    | 是                                  | 可以履行订单的几行，但不能部分履行各行，并且在 DOM 运行实例中，所有行必须来自同一位置。 （当前不支持此组合。） |
        | 3    | 是                    | 是                   | 否                                   | 可以履行订单的几行，可以部分履行各行，并且在 DOM 运行实例中，可以从多个位置履行每行。 |
        | 4\*  | 否                     | 不适用        | 否                                   | 必须履行所有订单行，不能部分履行各行，并且可以从不同位置履行每个订单行。 |
        | 5\*  | 否                     | 不适用        | 是                                  | 必须履行所有订单行，不能部分履行各行，并且只能从一个位置交付所有订单行。 |
        | 6\*  | 否                     | 不适用        | 否                                   | 此组合与组合 4 的工作方式相同，因为当 **履行部分订单** 设置为 **否** 时， **履行部分行** 不能设置为 **是** 。 |
        | 7\*  | 否                     | 不适用        | 是                                  | 此组合与组合 5 的工作方式相同，因为当 **履行部分订单** 为 **否** 时， **履行部分行** 不能为 **是** 。 |
        | 8    | 是                    | 否                    | 否                                   | 可以履行订单的几行，但不能部分履行各行，并且在 DOM 运行实例中，可以从多个位置履行各个订单行。 |
        | 9\*  | 否                     | 不适用        | 是                                  | 必须履行所有订单行，必须仅从单个位置履行所有订单行。 |

        \* 如果 **履行部分订单** 设置为 **否** ， **履行部分行** 将始终视为设置为 **否** ，而不管实际是如何设置的。

        > [!NOTE]
        > 在 Retail 版本 10.0.5 中，参数 **仅从一个位置履行订单** 已更改为 **最大履行位置数** 。 此前，用户可选择配置为仅从一个位置履行订单或者从尽可能多的位置履行订单；现在，用户可以指定是从确定的一组位置（最多 5 个）还是从尽可能多的位置履行订单。 这为可以从多少个位置履行订单提供了更大的灵活性。

   - **脱机履行库位规则** - 此规则允许组织将一个位置或一组位置指定为对 DOM 脱机或不可用，这样就无法将订单分配到这些位置进行履行。
    - **最大拒绝次数规则** - 此规则允许组织定义拒绝次数阈值。 当达到阈值时，DOM 处理器会将订单或订单行标记为异常，并将其从进一步处理中排除。

        将订单行分配到某个位置后，该位置可以拒绝分配的订单行，因为它可能会由于某些原因无法履行该行。 被拒绝的行将标记为异常，并重新放回池中，以供在下一次运行中处理。 在下一次运行期间，DOM 会尝试将拒绝的行分配到其他位置。 新位置也可以拒绝所分配的订单行。 此分配和拒绝周期可以发生多次。 当拒绝次数达到所拒绝的阈值时，DOM 会将该订单行标记为永久异常，并且不会再次选择该行来进行分配。 仅当用户手动重置订单行的状态时，DOM 才会考虑对该订单行进行重新分配。

   - **最大距离规则** - 此规则允许组织定义一个位置或一组位置可以达到的最大距离，以便履行订单。 如果为一个位置定义了重叠的最大距离规则，则 DOM 将应用为该位置定义的最大距离最低值。
    - **最大订单数规则** - 此规则允许组织定义一个位置或一组位置可以在一个日历日期间处理的最大订单数。 如果在一天中为一个位置分配了最大订单数，则在该日历日剩下的时间中 DOM 将不会为该位置分配任何更多的订单。

   下面是可以为所有前述规则类型定义的一些公共属性：

   - **开始日期** 和 **结束日期** - 使用这些字段可以为每个规则设置生效日期。
   - **已禁用** - 在 DOM 运行中将仅考虑此字段的值为 **否** 的规则。
   - **硬性约束** - 可以将规则定义为硬性约束或非硬性约束。 每次 DOM 运行都会经历两次迭代。 在第一个迭代中，每个规则都将被视为一个硬性约束规则，而不管此字段采用什么设置。 换言之，系统将应用每个规则。 唯一的例外是 **位置优先级** 规则。 在第二次迭代中，将会删除未定义为硬性约束的规则，并且应用所有规则时未分配到位置的订单或订单行将分配到位置。

10. 履行配置文件用于对规则、法人、销售订单来源和交货方式集合进行分组。 每次 DOM 运行针对特定的履行配置文件。 通过此方法，组织可以对具有特定销售订单来源和交货方式的订单运行一组法人的一组规则。 因此，如果必须对不同的销售订单来源或交货方式集运行不同的规则集，可以相应地定义履行配置文件。 要设置履行配置文件，请按照以下步骤操作：  

    1. 转到 **Retail 和 Commerce \> 分配的订单管理 \> 设置 \> 履行配置文件** 。
    2. 选择 **新建** 。
    3. 在 **配置文件** 和 **说明** 字段中输入值。
    4. 设置 **自动应用结果** 选项。 如果将此选项设置为 **是** ，则会自动将配置文件的 DOM 运行结果应用于销售订单行。 如果将此选项设置为 **否** ，则只能在履行计划中查看结果。 它们将不会应用于销售订单行。
    5. 如果想要对具有每个销售订单来源的订单（包括未定义销售订单来源的订单）运行 DOM 配置文件，请将 **处理销售订单来源为空的订单** 选项设置为 **是** 。 要仅对几个销售订单来源运行配置文件，可以在 **销售来源** 页面上定义，如后面所述。

    > [!NOTE]
    > 在 Commerce 版本 10.0.12 及更高版本中，必须在 **功能管理** 工作区中启用 **能够将履行组分配给履行配置文件** 。 
    >
    > 此功能将在 **履行配置文件** 页面上添加可以关联到单个履行组的新配置。 
    >
    > 如果选择了履行组，则履行该配置文件的 DOM 规则将能针对履行组中包括的“装运”仓库高效运行。 
    > 
    > 为了有效地使用此功能，请确保有一个包含所有装运仓库的履行组，然后将该履行组关联到履行配置文件。
    
    6. 在 **法人** 快速选项卡上，选择 **添加** ，然后选择一个法人。
    7. 在 **规则** 快速选项卡上，选择 **添加** ，然后选择要链接到该配置文件的规则。
    8. 重复前两个步骤，直至所有需要的规则与该配置文件关联。
    9. 选择 **保存** 。
    10. 在“操作”窗格上的 **设置** 选项卡中，选择 **交货方式** 。
    11. 在 **交货方式** 页面上，选择 **新建** 。
    12. 在 **公司** 字段中，选择相应法人。 公司列表仅限为先前添加的法人。
    13. 在 **交货方式** 字段中，选择要与此配置文件关联的交货方式。 交货方式不能与多个活动的配置文件关联。
    14. 重复前两个步骤，直至所有需要的交货方式与该配置文件关联。
    15. 关闭 **交货方式** 页面。
    16. 在“操作”窗格上的 **设置** 选项卡中，选择 **销售订单来源** 。
    17. 在 **销售来源** 页面上，选择 **新建** 。
    18. 在 **公司** 字段中，选择相应法人。 公司列表仅限为先前添加的法人。
    19. 在 **销售来源** 字段中，选择要与此配置文件关联的销售来源。 销售来源不能与多个活动的配置文件关联。
    20. 重复前两个步骤，直至所有需要的销售来源与该配置文件关联。
    21. 关闭 **销售来源** 页面。
    22. 将 **启用配置文件** 选项设置为 **是** 。 如果设置中存在任何错误，您将会收到警告消息。

## <a name="dom-processing"></a>DOM 处理

DOM 将仅在批处理作业中运行。 要为 DOM 运行配置批处理作业，请按照以下步骤操作。

1. 转到 **Retail 和 Commerce \> 分配的订单管理 \> 批处理 \> DOM 处理器作业设置** 。
1. 在 **参数** 快速选项卡上的 **履行配置文件** 字段中，选择必须对其运行 DOM 的配置文件。
1. 在 **在后台运行** 快速选项卡上的 **批处理组** 字段中，选择所配置的批处理组。
1. 在 **任务描述** 字段中，输入批处理作业的名称。
1. 选择 **重复执行** 并定义重新执行批处理作业。
1. 选择 **确定** 。

在处理时，DOM 将按照如下所述考虑订单和订单行：

- 满足 DOM 配置文件中为销售订单来源、交货方式和法人定义的条件，同时还满足任何下列条件的行：

    - 它们是从商业渠道创建的。
    - 它们从未由 DOM 代理。
    - 它们在先前由 DOM 代理，但标记为异常，并且低于尝试次数的最大阈值。
    - 交货方式不是提货或电子交货。
    - 它们未标记为交货。
    - 未手动将它们排除。

- 不处于暂停状态的订单

在应用规则、库存约束和优化之后，DOM 将选择与客户的交货地址最近的位置。

![销售订单条件](./media/ordercriteria.png "销售订单条件")

## <a name="results-of-dom-runs"></a>DOM 运行结果

如果履行配置文件设置为 **自动应用** ，则运行的结果将会自动应用于销售订单行，并且可以单独查看履行计划。 但是，如果履行配置文件未设置为 **自动应用** ，则只能从履行计划视图查看运行结果。 

要查看所生成的所有履行计划，请按照以下步骤操作。

1. 转到 **Retail 和 Commerce \> 分配的订单管理 \> 分配的订单管理** 。
2. 在 **分配的订单管理** 工作区中，选择 **履行计划** 磁贴。
3. 选择要查看履行计划的相关订单履行计划的 ID。

    履行计划的订单详细信息部分显示了作为运行一部分的原始销售订单行。 除了标准销售订单行字段外，订单详细信息部分还包括以下三个与 DOM 相关的字段：

    - **履行类型** - 此字段指示是已将销售订单行完全代理、部分代理还是根本未代理到某个位置。
    - **拆分** - 此字段指示是否已将某个销售订单行拆分并代理到其他位置。
    - **履行位置数** - 此字段指示为某个销售订单行创建了多少个履行行（基于原始销售订单行所代理到的位置数）。

    订单履行详细信息部分显示将原始销售订单行分配到了其他位置及其数量。

## <a name="order-line-actions-and-statuses"></a>订单行操作和状态

下面介绍了订单行上的设置。 要打开订单行，请转到 **Retail 和 Commerce \> 客户 \> 所有销售订单** 。
- 如果在销售订单行的 **常规** 选项卡上将 **从 DOM 处理中排除** 选项设置为 **是** ，则系统将从 DOM 处理中排除该订单或订单行。
- 销售订单行的 **常规** 选项卡上的 **DOM 状态** 字段可以设置为下列值之一：

    - **无** - 从未代理订单行。
    - **完成** - 已成功将订单行代理并分配到某个位置。
    - **异常** - 已成功代理订单行，但无法分配到某个位置。 从 DOM 工作区可以查看异常的多个子类型：

        - **无可用数量** - 位置中没有可用库存，无法向其分配订单。
        - **最大拒绝次数** - 订单行已达到拒绝次数的最大阈值。
        - **数据修改冲突** - 成功代理订单后发生更改的销售订单行。 因此，无法将履行计划应用于该订单。
        - **订单行特定异常** - 订单行上有多个异常。

- 在销售订单输入期间，可以在交互模式下运行 DOM。 输入订单行时，在指定产品和数量后，可以选择 **更新行** ，然后在 **DOM** 下，选择 **建议履行位置** 。 然后，您将看到一个基于 DOM 规则的位置列表，这些规则可以履行订单行上的数量。 该列表按距离排序。 选择一个位置以在销售订单行上设置相关场所和仓库。 要使此功能正常工作，必须存在现有的活动履行配置文件，该配置文件与销售行上的销售来源和交货模式匹配。
- 要查看销售订单行的 DOM 运行日志，请选择 **销售订单行** ，然后在 **DOM** 下选择 **查看 DOM 日志** 。 DOM 日志显示由 DOM 运行生成的所有事件和日志。 该日志可帮助您理解为什么将特定的位置分配到该订单行，以及什么规则和约束将为视为分配的一部分。 在 **管理** 选项卡上，还在销售订单头级别提供了 DOM 日志。

## <a name="run-a-clean-up-job-for-dom-fulfillment-plans"></a>对 DOM 履行计划运行清除作业

运行 DOM 处理时，将创建履行计划。 随着时间的推移，系统将会保留很多的履行计划。 要管理系统保留的履行计划数，可以基于 **保留期(天)** 值配置将删除较早履行计划的批处理作业。

1. 转到 **Retail 和 Commerce \> 分配的订单管理 \> 批处理 \> DOM 履行数据删除作业设置** 。 
1. 在 **批处理组** 字段中，选择所配置的批处理组。
1. 选择 **重复执行** 并定义重新执行批处理作业。
1. 选择 **确定** 。

## <a name="more-information"></a>更多信息

下面是在使用 DOM 功能时要考虑的一些事项：

- 当前，DOM 仅查看从商业渠道创建的订单。 当 **商业销售** 选项设置为 **是** 时，销售订单将标识为销售订单。
- Microsoft 未使用高级仓库管理功能对 DOM 进行测试。 客户和合作伙伴必须仔细判断 DOM 是否与高级仓库管理功能及其相关流程兼容。
- DOM 仅在云版本的 Commerce 中可用。 它在本地部署中不受支持。
