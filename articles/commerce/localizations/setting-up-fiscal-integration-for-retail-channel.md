---
title: 设置商业渠道的会计整合
description: 此主题提供为商业渠道设置会计整合功能的指南。
author: josaw
manager: annbe
ms.date: 02/01/2019
ms.topic: article
ms.prod: ''
ms.service: dynamics-365-retail
ms.technology: ''
ms.search.form: RetailFunctionalityProfile, RetailFormLayout, RetailParameters
audience: Application User
ms.reviewer: josaw
ms.search.region: Global
ms.search.industry: Retail
ms.author: epopov
ms.search.validFrom: 2018-11-1
ms.dyn365.ops.version: 8.1.1
ms.openlocfilehash: 475459e20bb53a726524311fb66ddd82dee454ef
ms.sourcegitcommit: eaf330dbee1db96c20d5ac479f007747bea079eb
ms.translationtype: HT
ms.contentlocale: zh-CN
ms.lasthandoff: 02/15/2021
ms.locfileid: "5231710"
---
# <a name="set-up-the-fiscal-integration-for-commerce-channels"></a>设置商业渠道的会计整合

[!include [banner](../includes/banner.md)]

## <a name="introduction"></a>简介

此主题提供为商业渠道设置会计整合功能的指南。 有关会计整合的详细信息，请参阅[商业渠道的会计整合概览](fiscal-integration-for-retail-channel.md)。

设置会计整合的流程包含以下任务：

1. 配置代表用于会计登记目的的会计设备或服务（如税控打印机）的会计连接器。
2. 配置生成会计连接器将在会计设备或服务中登记的会计单据的单据提供程序。
3. 配置定义会计登记步骤的会计登记流程和用于每个步骤的会计连接器和会计单据提供程序。
4. 将会计登记流程分配到销售点 (POS) 功能配置文件。
5. 将连接器技术配置文件分配到硬件配置文件。

## <a name="set-up-a-fiscal-registration-process"></a>设置会计登记流程

在使用会计集成功能之前，应配置以下设置。

1. 更新商业参数。

    1. 在 **商业共享参数** 页上，在 **常规** 选项卡上，将 **启用会计整合** 选项设置为 **是**。 在 **编号规则** 选项卡上，定义以下参考的编号规则：

        - 财政技术配置文件编号
        - 财政连接器组编号
        - 登记流程编号

    2. 在 **商业参数** 页上，为会计功能配置文件编号定义编号规则。

    > [!NOTE]
    > 编号规则是可选的。 所有会计整合实体的编号均可以从编号规则生成或手动生成。

2. 上载会计连接器和会计单据提供程序的配置。

    会计单据提供程序负责生成代表交易和事件的会计单据，这些交易和事件以同样用于与会计设备或服务交互的格式在 POS 上登记。 例如，会计单据提供程序可能生成 XML 格式的财务收据的表示形式。

    会计连接器负责与会计设备或服务的通信。 例如，会计连接器可能将会计单据提供程序以 XML 格式创建的财务收据发送到税控打印机。 有关会计整合组件的更多详细信息，请参阅[会计设备的会计整合流程和会计整合示例](fiscal-integration-for-retail-channel.md#fiscal-registration-process-and-fiscal-integration-samples-for-fiscal-devices)。

    1. 在 **会计连接器** 页（**Retail 和 Commerce  \> 渠道设置 \> 会计集成 \>会计连接器**）上，为您计划用于会计整合目的的每个设备或服务上载 XML 配置。

        > [!TIP]
        > 通过选择 **查看**，您可以查看与当前的会计连接器相关的所有功能和技术配置文件。

    2. 在 **会计单据提供程序** 页（**Retail 和 Commerce  \> 渠道设置 \> 会计集成 \> 会计单据提供程序**）上，为您计划使用的每个设备或服务上载 XML 配置。

        > [!TIP]
        > 通过选择 **查看**，您可以查看与当前的会计单据提供程序相关的所有功能配置文件。

    有关会计连接器和会计单据提供程序的示例，请参阅 [Retail SDK 中的会计整合示例](fiscal-integration-for-retail-channel.md#fiscal-integration-samples-in-the-retail-sdk)。

    > [!NOTE]
    > 数据映射被视为会计单据提供程序的一部分。 若要为相同连接器设置不同的数据映射（例如，州特定法规），您应创建不同的会计单据提供程序。

3. 创建连接器功能配置文件和连接器技术配置文件。

    1. 在 **连接器功能配置文件** 页（**Retail 和 Commerce \> 渠道设置 \> 会计整合 \> 连接器功能配置文件**）上，为与此会计连接器相关的会计连接器和会计单据提供程序的每个组合创建连接器功能配置文件。

        1. 选择连接器名称。
        2. 选择单据提供程序。

        您可以更改连接器功能配置文件中的数据映射参数。 若要还原在会计单据提供程序配置中定义的默认参数，请选择 **更新**。

        **示例**

        |   | 格式 | 示例 |
        |---|--------|---------|
        | **增值税税率设置** | 值 : VATrate | 1 : 2000、2 : 1800 |
        | **增值税代码映射** | VATcode : 值 | vat20 : 1、vat18 : 2 |
        | **支付方式映射** | TenderType：值 | 现金 : 1、卡 : 2 |

        > [!NOTE]
        > 连接器功能配置文件是公司特定的。 如果您计划使用不同公司的会计连接器和会计单据提供程序的相同组合，应为每个公司创建连接器功能配置文件。

    2. 在 **连接器技术配置文件** 页（**Retail 和 Commerce \> 渠道设置 \> 会计整合 \> 连接器技术配置文件**）上，为每个会计连接器创建连接器技术配置文件。

        1. 选择连接器名称。
        2. 选择连接器类型。 对于连接到硬件工作站的设备，请选择 **本地**。

            > [!NOTE]
            > 当前仅支持本地连接器。

        连接器技术配置文件中的 **设备** 和 **设置** 选项卡上的参数可以更改。 若要还原在会计连接器配置中定义的默认参数，请选择 **更新**。 在 XML 配置的新版本加载后，您将收到一则消息，显示当前会计连接器或会计单据提供程序已经在使用。 此过程不会覆盖之前在连接器功能配置文件和连接器技术配置文件中进行的手动更改。 要应用来自新配置的一组默认参数，在 **连接器功能配置文件** 页或 **连接器技术配置文件** 页上，选择 **更新**。

4. 创建会计连接器组。

    会计连接器组将执行相同功能并在会计登记流程的同一个步骤使用的会计连接器的功能配置文件组合在一起。 例如，如果多个税控打印机型号可用于商店，这些税控打印机的会计连接器可以在会计连接器组中组合在一起。

    1. 在 **会计连接器组** 页（**Retail 和 Commerce \> 渠道设置 \> 会计整合 \> 会计连接器组**），创建新的会计连接器组。
    2. 向连接器组添加功能配置文件。 在 **功能配置文件** 选项卡上，选择 **添加** 并选择配置文件编号。 连接器组内的每个会计连接器只能有一个功能配置文件。
    3. 如果要暂停功能配置文件的使用，将 **禁用** 选项设置为 **是**。 此更改只影响当前的连接器组。 您可以在其他连接器组中继续使用相同的功能配置文件。

5. 创建会计登记流程。

    会计登记流程由登记步骤的顺序和用于每个步骤的连接器组定义。

    1. 在 **会计登记流程** 页（**Retail 和 Commerce \> 渠道设置 \> 会计整合 \> 会计登记流程**），为每个会计登记的唯一流程创建新记录。
    2. 向流程添加登记步骤：

        1. 选择 **添加**。
        2. 选择会计连接器类型。
        3. 在 **组编号** 字段中，选择一个合适的会计连接器组。

6. 将会计登记流程的实体分配到 POS 配置文件。

    1. 在 **POS 功能配置文件** 页（**Retail 和 Commerce \> 渠道设置 \> POS 设置 \> POS 配置文件 \> 功能配置文件**），将会计登记流程分配到 POS 功能配置文件。 选择 **编辑**，然后，在 **会计登记流程** 选项卡上，在 **流程编号** 字段中，选择流程。
    2. 在 **POS 硬件配置文件** 页（**Retail 和 Commerce \> 渠道设置 \> POS 设置 \> POS 配置文件 \> 硬件配置文件**），将连接器技术配置文件分配到硬件配置文件。 选择 **编辑**，在 **会计外围设备** 选项卡上添加一个行，然后，在 **配置文件编号** 字段中，选择连接器技术配置文件。

    > [!NOTE]
    > 您可以将多个技术配置文件添加到同一个硬件配置文件。 但是，硬件配置文件或 POS 功能配置文件仅应具有与任何会计连接器组的一个交集。

    会计登记流由会计登记流程还有会计整合组件的某些参数定义：会计单据提供程序的 Commerce runtime 扩展和会计连接器的硬件工作站扩展。

    - 对会计登记的事件和交易的订阅在会计单据提供程序中预定义。
    - 会计单据提供程序还负责识别用于会计登记的会计连接器。 它将为会计登记流程的当前步骤指定的会计连接器组中包含的连接器功能配置文件，与分配到 POS 与之配对的硬件工作站的硬件配置文件的连接器技术配置文件相匹配。
    - 会计单据提供程序使用来自会计单据配置的数据映射设置在生成会计单据时转换交易/事件数据，如纳税和付款。
    - 在会计单据提供程序生成会计单据时，会计连接器可以将其原样发送到会计设备，或者根据如何处理通信，分析并将其转换为设备应用程序编程接口 (API) 的一系列命令。

7. 在 **会计登记流程** 页（**Retail 和 Commerce \> 渠道设置 \> 会计整合 \> 会计登记流程**），选择 **验证** 来验证会计登记流程。

    我们建议您在以下情况下运行此类验证：

    - 在完成了新登记流程的所有设置后，包括当您将登记流程分配到 POS 功能配置文件和硬件配置文件时。
    - 在您对现有会计登记流程进行更改后，这些更改可能在运行时导致选择不同的会计连接器（例如，如果您更改会计登记流程步骤的连接器组，请在连接器组中启用连接器功能配置文件，或将新连接器功能配置文件添加到连接器组）。
    - 在您对连接器技术配置文件到硬件配置文件的分配进行更改后。

8. 在 **配送调度** 页，运行 **1070** 和 **1090** 作业将数据传输到渠道数据库。

## <a name="set-up-fiscal-texts-for-discounts"></a>设置折扣的会计文本

在某些情况下，如果应用了折扣，必须在财务收据上打印特殊文本。 您可以在 **会计连接器组** 页（**Retail 和 Commerce \> 渠道设置 \> 会计整合 \> 会计连接器组**）设置折扣的会计文本。

- 对于在 POS 应用的手动折扣，您应该为在 POS 功能配置文件中指定为 **产品折扣** 信息代码的信息代码或信息代码组设置会计文本。

    1. 在 **会计连接器组** 页，选择 **财务收据文本**。
    2. 在 **信息代码** 选项卡上，选择 **添加**，然后选择信息代码或信息代码组。
    3. 在 **信息代码编号** 中，选择一个值。
    4. 在 **子代码编号** 字段中，如果所选信息代码需要子代码，则选择一个值。
    5. 在 **财务收据文本** 字段中，指定应在财务收据上打印的会计文本。
    6. 将 **在财务收据上打印用户输入** 选项设置为 **是** 使用用户在 POS 手动输入的信息覆盖财务收据上的文本。 此选项仅适用于输入类型为 **文本** 的信息代码。

    > [!NOTE]
    > 您可以指定多个信息代码的会计文本来支持使用信息代码组、链接的信息代码和触发的信息代码的情况。 在这些情况下，财务收据将包含来自链接到应用了折扣的交易记录行的所有信息代码的会计文本。

- 对于渠道特定折扣，应定义折扣 ID 的会计文本。

    1. 在 **会计连接器组** 页，选择 **财务收据文本**。
    2. 在 **折扣** 选项卡上，选择 **添加**，然后选择折扣 ID。
    3. 在 **财务收据文本** 字段中，指定应在财务收据上打印的会计文本。

    > [!NOTE]
    > 如果多个折扣应用于同一个交易记录行，财务收据将包含来自链接到这些交易记录行的所有折扣的会计文本。

## <a name="set-error-handling-settings"></a>设置错误处理设置

会计整合中提供的错误处理选项在会计登记流程中设置。 有关会计整合中的错误处理的详细信息，请参阅[错误处理](fiscal-integration-for-retail-channel.md#error-handling)。

1. 在 **会计登记流程** 页（**Retail 和 Commerce \> 渠道设置 \> 会计整合 \> 会计登记流程**），您可以为会计登记流程的每个步骤设置以下参数：

    - **允许跳过** – 此参数启用错误处理对话框中的 **跳过** 选项。
    - **允许标记为已登记** – 此参数启用错误处理对话框中的 **标记为已登记** 选项。
    - **出错时继续** –如果启用此参数，并且交易记录或事件的会计登记失败，POS 收银机上将继续进行会计登记流程。 但是，若要运行下一个交易记录或事件的会计登记，操作员必须重试失败的会计登记，跳过，或将交易记录或事件标记为已登记。 有关详细信息，请参阅[可选会计登记](fiscal-integration-for-retail-channel.md#optional-fiscal-registration)。

    > [!NOTE]
    > 如果启用了 **出错时继续** 参数，将自动禁用 **允许跳过** 和 **允许标记为已登记** 参数。

2. 错误处理对话框中的 **跳过** 和 **标记为已登记** 选项需要 **允许跳过登记或标记为已登记** 权限。 因此，在 **权限组** 页（**Retail 和 Commerce \> 员工 \> 权限组**），应启用 **允许跳过登记或标记为已登记** 权限。
3. **跳过** 和 **标记为已登记** 选项让操作员可以在会计登记失败时输入附加信息。 若要让此功能可用，您应该在会计连接器组中指定 **跳过** 和 **标记为已登记** 信息代码。 操作员输入的信息然后保存为链接到会计交易记录的信息代码交易记录。 有关信息代码的更多详细信息，请参阅[信息代码和信息代码组](../info-codes-retail.md)。

    > [!NOTE]
    > 在会计连接器组中用于 **跳过** 和 **标记为已登记** 的信息代码不支持 **产品** 触发器函数。

    - 在 **会计连接器组** 页，在 **信息代码** 选项卡上，在 **跳过** 和 **标记为已登记** 字段中选择信息代码或信息代码组。

    > [!NOTE]
    > 会计登记流程的任何步骤均可以生成一个会计单据和一个非会计单据。 会计单据提供程序扩展识别与会计或非会计单据相关的每个交易或事件的类型。 错误处理功能仅应用于会计单据。
    >
    > - **会计单据** – 应该成功登记的必需文档（例如，财务收据）。
    > - **非会计单据** – 交易或事件的补充单据（例如，礼品卡单）。

4. 如果操作员必须可以在发生了运行状况检查错误之后继续处理当前操作（例如，创建或完成交易记录），那么您应该启用 **权限组** 页面上的 **允许跳过运行状况检查错误** 权限（**Retail 和 Commerce \> 员工 \> 权限组**）。 有关运行状况检查过程的详细信息，请参阅[会计登记运行状况检查](fiscal-integration-for-retail-channel.md#fiscal-registration-health-check)。

## <a name="set-up-fiscal-xz-reports-from-the-pos"></a>从 POS 设置会计 X/Z 报表

若要让会计 X/Z 报表从 POS 运行，您应将新按钮添加到 POS 布局。

- 在 **按钮网格** 页，请按照[使用按钮网格设计器将 POS 操作添加到 POS 布局](../dev-itpro/add-pos-operations.md#add-a-custom-operation-button-to-the-pos-layout-in-retail-headquarters)中的说明安装设计器、更新 POS 布局。

    1. 选择要更新的布局。 
    2. 添加新按钮，并设置 **打印会计 X** 按钮属性。
    3. 添加新按钮，并设置 **打印会计 Z** 按钮属性。
    4. 在 **配送计划** 页，运行 **1090** 作业将更改传输到渠道数据库。

## <a name="enable-manual-execution-of-postponed-fiscal-registration"></a>启用已推迟会计登记的手动执行

若要启用已延迟会计登记的手动执行，应该向 POS 布局添加一个新按钮。

- 在 **按钮网格** 页，请按照[使用按钮网格设计器将 POS 操作添加到 POS 布局](../dev-itpro/add-pos-operations.md#add-a-custom-operation-button-to-the-pos-layout-in-retail-headquarters)中的说明安装设计器、更新 POS 布局。

    1. 选择要更新的布局。
    2. 添加新按钮，并设置 **完成会计登记流程** 按钮属性。
    3. 在 **配送计划** 页，运行 **1090** 作业将更改传输到渠道数据库。


[!INCLUDE[footer-include](../../includes/footer-banner.md)]