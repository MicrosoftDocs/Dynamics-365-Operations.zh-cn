---
title: 设置商业渠道的会计整合
description: 本文提供为商业渠道设置会计整合功能的指南。
author: EvgenyPopovMBS
ms.date: 10/04/2022
ms.topic: article
audience: Application User, Developer, IT Pro
ms.reviewer: v-chgriffin
ms.search.region: Global
ms.author: josaw
ms.search.validFrom: 2017-06-20
ms.openlocfilehash: 28097341c7b39660b834eb81786c3f56045e1496
ms.sourcegitcommit: 2bc6680dc6b12d20532d383a0edb84d180885b62
ms.translationtype: HT
ms.contentlocale: zh-CN
ms.lasthandoff: 10/06/2022
ms.locfileid: "9631415"
---
# <a name="set-up-the-fiscal-integration-for-commerce-channels"></a>设置商业渠道的会计整合

[!include [banner](../includes/banner.md)]

本文提供为商业渠道设置会计整合功能的指南。 有关会计整合的详细信息，请参阅[商业渠道的会计整合概览](fiscal-integration-for-retail-channel.md)。

## <a name="enable-features-in-commerce-headquarters"></a>在 Commerce Headquarters 中启用功能

若要启用与 Commerce 渠道的会计集成功能相关的功能，请执行以下步骤。

1. 在 Commerce Headquarters 中，转到 **系统管理 \> 工作区 \> 功能管理**。
1. 查找并启用以下功能：

    - **来自 POS 收银机的直接会计集成** – 此功能通过添加创建将在销售点 (POS) 中运行的会计连接器的功能来扩展会计整合框架。 此类连接器与提供 HTTP 应用编程接口 (API) 的会计设备或服务进行通信，并且不需要商店中的专用物理机器。 例如，此功能支持移动设备的会计集成，而无需共享硬件站。
    - **会计整合技术配置文件替代** – 此功能可以扩展会计整合的配置，并添加替代技术配置文件参数的功能。 例如，可以在单个 POS 收银机级别指定会计设备连接字符串。 此功能还增加了在 POS 收银机的 **设置** 页面上检查连接参数的可能性。 
    - **POS 收银机的会计登记状态** – 启用此功能后，您可以禁用特定 POS 收银机的会计登记流程。 如果对 POS 收银机禁用会计登记，则无法在该收银机上完成销售交易。
    - **会计整合本地存储备份** – 此功能通过启用会计登记数据的自动备份扩展了会计整合框架的错误处理功能，以可以在激活设备时还原本地存储中的数据。
    - **已推迟单据登记** - 此功能通过启用在会计登记失败时推迟会计登记，使用备用会计登记选项或稍后通过会计整合框架以外的方式完成会计登记的选项，扩展了会计整合框架的错误处理功能。

## <a name="set-up-commerce-parameters"></a>设置 Commerce 参数

要设置 Commerce 参数，请执行以下步骤。

1. 在 **商业共享参数** 页上，在 **常规** 选项卡上，将 **启用会计整合** 选项设置为 **是**。
1. 在 **编号规则** 选项卡上，定义以下参考的编号规则：

    - 财政技术配置文件编号
    - 财政连接器组编号
    - 登记流程编号

1. 在 **商业参数** 页上，为会计功能配置文件编号定义编号规则。

> [!NOTE]
> 编号规则是可选的。 所有会计整合实体的编号均可以从编号规则生成或手动生成。

## <a name="set-up-a-fiscal-registration-process"></a>设置会计登记流程

设置会计整合的流程包含以下任务：

- 配置代表用于会计登记目的的会计设备或服务（如税控打印机）的会计连接器。
- 配置生成会计连接器将在会计设备或服务中登记的会计单据的单据提供程序。
- 配置定义会计登记步骤的会计登记流程和用于每个步骤的会计连接器和会计单据提供程序。
- 将会计登记流程分配到 POS 功能配置文件。
- 将连接器技术配置文件分配到硬件配置文件。
- 将连接器技术配置文件分配到 POS 硬件或功能配置文件。

### <a name="upload-configurations-of-fiscal-document-providers"></a>上载会计单据提供程序的配置

会计单据提供程序负责生成代表交易和事件的会计单据，这些交易和事件以同样用于与会计设备或服务交互的格式在 POS 上登记。 例如，会计单据提供程序可能生成 XML 格式的财务收据的表示形式。

要上载会计单据提供程序的配置，请执行以下步骤。

1. 在 Commerce headquarters 中，转到 **会计单据提供程序** 页面（**Retail 和 Commerce \> 渠道设置 \> 会计整合 \> 会计单据提供程序**）。
1. 为您计划使用的每个设备或服务上载 XML 配置。

> [!TIP]
> 通过选择 **查看**，您可以查看与当前的会计单据提供程序相关的所有功能配置文件。

> [!NOTE]
> 数据映射被视为会计单据提供程序的一部分。 若要为相同连接器设置不同的数据映射（例如，州特定法规），您应创建不同的会计单据提供程序。

### <a name="upload-configurations-of-fiscal-connectors"></a>上载会计连接器的配置

会计连接器负责与会计设备或服务的通信。 例如，会计连接器可能将会计单据提供程序以 XML 格式创建的财务收据发送到税控打印机。 有关会计整合组件的更多详细信息，请参阅[会计设备和服务的会计整合流程和会计整合示例](fiscal-integration-for-retail-channel.md#fiscal-registration-process-and-fiscal-integration-samples-for-fiscal-devices-and-services)。

要上载会计连接器的配置，请执行以下步骤。

1. 在 Commerce headquarters 中，转到 **会计连接器** 页面（**Retail 和 Commerce \> 渠道设置 \> 会计整合 \> 会计连接器**）。
1. 为您计划用于会计整合的每个设备或服务上载 XML 配置。

> [!TIP]
> 通过选择 **查看**，您可以查看与当前的会计连接器相关的所有功能和技术配置文件。

有关会计连接器和会计单据提供程序的示例，请参阅 [Commerce SDK 中的会计整合示例](fiscal-integration-for-retail-channel.md#fiscal-integration-samples-in-the-commerce-sdk)。

### <a name="create-connector-functional-profiles"></a>创建连接器功能配置文件

要创建连接器功能配置文件，请执行以下步骤。

1. 在 Commerce headquarters 中，转到 **连接器功能配置文件** 页面（**Retail 和 Commerce \> 渠道设置 \> 会计整合 \> 连接器功能配置文件**）。
1. 对于与此会计连接器相关的会计连接器和会计单据提供程序的每个组合，按照以下步骤创建连接器功能配置文件：

    1. 选择连接器名称。
    1. 选择单据提供程序。

#### <a name="change-data-mapping-parameters-in-a-connector-functional-profile"></a>更改连接器功能配置文件中的数据映射参数

您可以更改连接器功能配置文件中的数据映射参数。 下表提供了连接器功能配置文件中数据映射参数的一些示例。

| 参数 | 格式 | 示例 |
|-----------|--------|---------|
| 增值税税率设置 | 值 : VATrate | 1 : 2000、2 : 1800 |
| 增值税代码映射 | VATcode : 值 | vat20 : 1、vat18 : 2 |
| 支付方式映射 | TenderType：值 | 现金 : 1、卡 : 2 |

要还原在会计单据提供程序配置中定义的默认参数，在 **连接器功能配置文件** 页面上选择 **更新**。

> [!NOTE]
> 连接器功能配置文件是公司特定的。 如果您计划使用不同公司的会计连接器和会计单据提供程序的相同组合，应为每个公司创建连接器功能配置文件。

### <a name="create-connector-technical-profiles"></a>创建连接器技术配置文件

要创建连接器技术配置文件，请执行以下步骤。

1. 在 Commerce headquarters 中，转到 **连接器技术配置文件** 页面（**Retail 和 Commerce \> 渠道设置 \> 会计整合 \> 连接器技术配置文件**）。
1. 通过以下步骤为每个会计连接器创建连接器技术配置文件：

    1. 选择连接器名称。
    1. 选择连接器类型：

        - 对于连接到硬件工作站或存在于本地网络中的设备或服务，选择 **本地**。
        - 对于外部服务，选择 **外部**。
        - 对于 Commerce runtime (CRT) 中的内部连接器，选择 **内部**。 

    1. 选择连接器位置：

        - 如果连接器位于硬件工作站，选择 **硬件工作站**。
        - 如果连接器位于 POS 收银机，选择 **收银机**。

连接器技术配置文件中的 **设备** 和 **设置** 选项卡上的参数可以更改。 若要还原在会计连接器配置中定义的默认参数，请选择 **更新**。 在 XML 配置的新版本加载时，您将收到一则消息，显示当前会计连接器或会计单据提供程序已经在使用。 此过程不会覆盖之前在连接器功能配置文件和连接器技术配置文件中进行的手动更改。 要应用来自新配置的一组默认参数，在 **连接器功能配置文件** 页或 **连接器技术配置文件** 页上选择 **更新**。

如果您必须为单个 POS 收银机或商店设置特定参数，请按照这些步骤操作。

1. 选择 **替代** 菜单项。
1. 在 **替代** 页面上，创建新记录。
1. 选择商店或 POS 收银机。 您可以替代单个 POS 收银机或单个商店中所有 POS 收银机的所选技术配置文件的参数。
1. 在 **设备** 选项卡上，为所选 POS 收银机或商店输入参数。

### <a name="create-fiscal-connector-groups"></a>创建会计连接器组

会计连接器组将执行相同功能并在会计登记流程的同一个步骤使用的会计连接器的功能配置文件组合在一起。 例如，如果多个税控打印机型号可用于商店，这些税控打印机的会计连接器可以在会计连接器组中组合在一起。

要创建会计连接器组，请执行这些步骤。

1. 转到 **会计连接器组** 页面（**Retail 和 Commerce \> 渠道设置 \> 会计整合 \> 会计连接器组**）。
1. 创建新的会计连接器组。
1. 向连接器组添加功能配置文件。 在 **功能配置文件** 选项卡上，选择 **添加** 并选择配置文件编号。 连接器组内的每个会计连接器只能有一个功能配置文件。
1. 如果要暂停功能配置文件的使用，将 **禁用** 选项设置为 **是**。 此更改只影响当前的连接器组。 您可以在其他连接器组中继续使用相同的功能配置文件。

### <a name="create-a-fiscal-registration-process"></a>创建会计登记流程

会计登记流程由登记步骤的顺序和用于每个步骤的连接器组定义。

要创建会计登记流程，请执行以下步骤。

1. 在 Commerce headquarters 中，转到 **会计登记流程** 页面（**Retail 和 Commerce \> 渠道设置 \> 会计整合 \> 会计登记流程**）。
1. 为每个唯一的会计登记流程创建新记录。
1. 按照以下步骤向流程添加登记步骤：

    1. 选择 **添加**。
    1. 选择会计连接器类型。
    1. 在 **组编号** 字段中，选择一个合适的会计连接器组。

### <a name="assign-entities-of-the-fiscal-registration-process-to-pos-profiles"></a>将会计登记流程的实体分配到 POS 配置文件

要将会计登记流程的实体分配到 POS 配置文件，请执行以下步骤。

1. 在 Commerce headquarters 中，转到 **POS 功能配置文件** 页面（**Retail 和 Commerce \> 渠道设置 \> POS 设置 \> POS 配置文件 \> 功能配置文件**）。 
1. 将会计登记流程分配到 POS 功能配置文件。
1. 选择 **编辑**，然后，在 **会计登记流程** 选项卡上，在 **流程编号** 字段中，选择流程。
1. 在 **会计服务** 选项卡上，选择连接器位置 **收银机** 的连接器技术配置文件。
1. 转到 **POS 硬件配置文件** 页面（**Retail 和 Commerce \> 渠道设置 \> POS 设置 \> POS 配置文件 \> 硬件配置文件**）。
1. 将连接器技术配置文件分配到硬件配置文件。 
1. 选择 **编辑**，然后在 **会计外围设备** 选项卡上添加行。 
1. 在 **配置文件编号** 字段中，选择连接器技术配置文件。
1. 在 **会计外围设备** 选项卡上，选择连接器位置 **硬件工作站** 的连接器技术配置文件。

> [!NOTE]
> 您可以将多个技术配置文件添加到同一个硬件配置文件。 但是，硬件配置文件或 POS 功能配置文件仅应具有与任何会计连接器组的一个交集。

会计登记流由会计登记流程还有会计整合组件的某些参数定义：会计单据提供程序的 CRT 扩展和会计连接器的硬件工作站扩展。

- 对会计登记的事件和交易的订阅在会计单据提供程序中预定义。
- 会计单据提供程序还负责识别用于会计登记的会计连接器。 它将为会计登记流程的当前步骤指定的会计连接器组中包含的连接器功能配置文件，与分配到 POS 与之配对的硬件工作站的硬件配置文件的连接器技术配置文件相匹配。
- 会计单据提供程序使用来自会计单据配置的数据映射设置在生成会计单据时转换交易/事件数据，如纳税和付款。
- 在会计单据提供程序生成会计单据时，会计连接器可以将其原样发送到会计设备，或者根据如何处理通信，分析并将其转换为设备 API 的一系列命令。

### <a name="set-up-registers-with-fiscal-registration-restrictions"></a>设置具有会计登记限制的收银机

您可以选择禁止进行会计登记的收银机，例如，在您只需要在这些设备上提供产品目录搜索、客户查找或交易草稿创建等非会计操作的情况下。

要设置具有会计登记限制的收银机，请按照以下步骤操作。

1. 在Commerce headquarters 中，转到 **Retail 和 Commerce \> 渠道设置 \> 会计整合 \> 会计登记流程**。
1. 选择所需的流程。
1. 选择 **具有会计流程限制的 POS 收银机** 选项卡。
1. 根据需要添加具有会计流程限制的收银机。

### <a name="validate-the-fiscal-registration-process"></a>验证会计登记流程

建议您在以下情况下验证会计登记流程：

- 您已完成新登记流程的所有设置。 这些设置包括将登记流程分配给 POS 功能配置文件和硬件配置文件。
- 您对现有会计登记流程进行了更改，这些更改可能导致在运行时选择其他会计连接器。 （例如，您更改了会计登记流程步骤的连接器组，在连接器组中启用了连接器功能配置文件，或将新的连接器功能配置文件添加到连接器组。）
- 您对连接器技术配置文件到硬件配置文件的分配进行了更改。

要验证会计登记流程，请执行以下步骤。

1. 在 Commerce headquarters 中，转到 **会计登记流程** 页面（**Retail 和 Commerce \> 渠道设置 \> 会计整合 \> 会计登记流程**）。
1. 选择 **验证** 对会计登记流程进行验证。
1. 在 **配送调度** 页，运行 **1070** 和 **1090** 作业将数据传输到渠道数据库。

## <a name="set-up-fiscal-texts-for-discounts"></a>设置折扣的会计文本

在某些情况下，如果应用了折扣，必须在财务收据上打印特殊文本。 您可以在 **会计连接器组** 页（**Retail 和 Commerce \> 渠道设置 \> 会计整合 \> 会计连接器组**）设置折扣的会计文本。

- 对于在 POS 应用的手动折扣，您应该为在 POS 功能配置文件中指定为 **产品折扣** 信息代码的信息代码或信息代码组设置会计文本。

    1. 在 **会计连接器组** 页，选择 **财务收据文本**。
    1. 在 **信息代码** 选项卡上，选择 **添加**，然后选择信息代码或信息代码组。
    1. 在 **信息代码编号** 字段中，选择一个值。
    1. 在 **子代码编号** 字段中，如果所选信息代码需要子代码，则选择一个值。
    1. 在 **财务收据文本** 字段中，指定应在财务收据上打印的会计文本。
    1. 将 **在财务收据上打印用户输入** 选项设置为 **是** 使用用户在 POS 手动输入的信息覆盖财务收据上的文本。 此选项仅适用于输入类型为 **文本** 的信息代码。

    > [!NOTE]
    > 您可以指定多个信息代码的会计文本来支持使用信息代码组、链接的信息代码和触发的信息代码的情况。 在这些情况下，财务收据将包含来自链接到应用了折扣的交易记录行的所有信息代码的会计文本。

- 对于渠道特定折扣，应定义折扣 ID 的会计文本。

    1. 在 **会计连接器组** 页，选择 **财务收据文本**。
    1. 在 **折扣** 选项卡上，选择 **添加**，然后选择折扣 ID。
    1. 在 **财务收据文本** 字段中，指定应在财务收据上打印的会计文本。

    > [!NOTE]
    > 如果多个折扣应用于同一个交易记录行，财务收据将包含来自链接到这些交易记录行的所有折扣的会计文本。

## <a name="set-error-handling-settings"></a>设置错误处理设置

会计整合中提供的错误处理选项在会计登记流程中设置。 有关会计整合中的错误处理的详细信息，请参阅[错误处理](fiscal-integration-for-retail-channel.md#error-handling)。

要设置错误处理设置，请按照这些步骤操作。

1. 在 **会计登记流程** 页（**Retail 和 Commerce \> 渠道设置 \> 会计整合 \> 会计登记流程**），您可以为会计登记流程的每个步骤设置以下参数：

    - **允许跳过** – 此参数启用错误处理对话框中的 **跳过** 选项。
    - **允许标记为已登记** – 此参数启用错误处理对话框中的 **标记为已登记** 选项。
    - **允许推迟** – 此参数启用错误处理对话框中的 **推迟** 选项。
    - **出错时继续** –如果启用此参数，并且交易记录或事件的会计登记失败，POS 收银机上将继续进行会计登记流程。 但是，若要运行下一个交易记录或事件的会计登记，操作员必须重试失败的会计登记，跳过，或将交易记录或事件标记为已登记。 有关详细信息，请参阅[可选会计登记](fiscal-integration-for-retail-channel.md#optional-fiscal-registration)。

    > [!NOTE]
    > 如果启用了 **出错时继续** 参数，将自动禁用 **允许跳过** 和 **允许标记为已登记** 参数。

1. 错误处理对话框中的 **跳过** 和 **标记为已登记** 选项需要启用 **允许跳过登记或标记为已登记** 权限。 要启用此权限，转到 **权限组** 页（**Retail 和 Commerce \> 员工 \> 权限组**），将 **允许跳过登记或标记为已登记** 选项设置为 **是**。
1. 错误处理对话框中的 **推迟** 选项需要启用 **允许推迟** 权限。 要启用此权限，转到 **权限组** 页（**Retail 和 Commerce \> 员工 \> 权限组**），将 **允许推迟** 选项设置为 **是**。
1. **跳过**、**标记为已登记** 和 **推迟** 选项让操作员可以在会计登记失败时输入附加信息。 要让此功能可用，您应该在会计连接器组中指定 **跳过**、**标记为已登记** 和 **推迟** 信息代码。 操作员输入的信息然后保存为链接到会计交易记录的信息代码交易记录。 有关信息代码的更多详细信息，请参阅[信息代码和信息代码组](../info-codes-retail.md)。

    > [!NOTE]
    > 在会计连接器组中用于 **跳过** 和 **标记为已登记** 的信息代码不支持 **产品** 触发器函数。

    - 在 **会计连接器组** 页，在 **信息代码** 选项卡上，在 **跳过**、**标记为已登记** 和 **推迟** 字段中选择信息代码或信息代码组。

    > [!NOTE]
    > 会计登记流程的任何步骤均可以生成一个会计单据和一个非会计单据。 会计单据提供程序扩展识别与会计或非会计单据相关的每个交易或事件的类型。 错误处理功能仅应用于会计单据。
    >
    > - **会计单据** – 应该成功登记的必需文档（例如，财务收据）。
    > - **非会计单据** – 交易或事件的补充单据（例如，礼品卡单）。

1. 如果操作员必须可以在发生了运行状况检查错误之后继续处理当前操作（例如，创建或完成交易记录），那么您应该启用 **权限组** 页面上的 **允许跳过运行状况检查错误** 权限（**Retail 和 Commerce \> 员工 \> 权限组**）。 有关运行状况检查过程的详细信息，请参阅[会计登记运行状况检查](fiscal-integration-for-retail-channel.md#fiscal-registration-health-check)。

## <a name="set-up-fiscal-xz-reports-from-the-pos"></a>从 POS 设置会计 X/Z 报表

若要让会计 X/Z 报表从 POS 运行，您应将新按钮添加到 POS 布局。

- 在 **按钮网格** 页，请按照[使用按钮网格设计器将 POS 操作添加到 POS 布局](../dev-itpro/add-pos-operations.md#add-a-custom-operation-button-to-the-pos-layout-in-retail-headquarters)中的说明安装设计器、更新 POS 布局。

    1. 选择要更新的布局。 
    1. 添加新按钮，并设置 **打印会计 X** 按钮属性。
    1. 添加新按钮，并设置 **打印会计 Z** 按钮属性。
    1. 在 **配送计划** 页，运行 **1090** 作业将更改传输到渠道数据库。

## <a name="enable-manual-execution-of-deferred-fiscal-registration"></a>启用已推迟会计登记的手动执行

若要启用已推迟会计登记的手动执行，应该向 POS 布局添加一个新按钮。

- 在 **按钮网格** 页，请按照[使用按钮网格设计器将 POS 操作添加到 POS 布局](../dev-itpro/add-pos-operations.md#add-a-custom-operation-button-to-the-pos-layout-in-retail-headquarters)中的说明安装设计器、更新 POS 布局。

    1. 选择要更新的布局。
    1. 添加新按钮，并设置 **完成会计登记流程** 按钮属性。
    1. 在 **配送计划** 页，运行 **1090** 作业将更改传输到渠道数据库。

## <a name="view-connection-parameters-and-other-information-in-pos"></a>查看 POS 中的连接参数和其他信息

要查看 POS 中的连接参数和其他信息，请执行以下步骤。

1. 打开 Modern POS (MPOS) 或 Cloud POS (CPOS)。
1. 选择 **设置**。 如果启用会计整合，则右侧的 **会计整合** 部分将显示以下信息：

    - 会计登记的状态
    - 上次会计交易的状态
    - 待定审计事件的数量

1. 选择 **详细信息** 以查看以下消息：

    - 登记流程步骤
    - 连接参数
    - 审计事件详细信息
 
[!INCLUDE[footer-include](../../includes/footer-banner.md)]
